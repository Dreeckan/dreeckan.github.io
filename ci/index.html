<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Intégration continue</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Les formations de Rémi Jarjat pour Human Booster">
    
    <link rel="preload" href="/assets/css/0.styles.f78ef515.css" as="style"><link rel="preload" href="/assets/js/app.a0283a3d.js" as="script"><link rel="preload" href="/assets/js/2.2bb1f65b.js" as="script"><link rel="preload" href="/assets/js/8.82725242.js" as="script"><link rel="prefetch" href="/assets/js/10.a27b6e9d.js"><link rel="prefetch" href="/assets/js/11.2193e9e3.js"><link rel="prefetch" href="/assets/js/12.f39a5b44.js"><link rel="prefetch" href="/assets/js/13.2d6a44aa.js"><link rel="prefetch" href="/assets/js/14.0673e9ad.js"><link rel="prefetch" href="/assets/js/15.a5eeeada.js"><link rel="prefetch" href="/assets/js/16.33dfc880.js"><link rel="prefetch" href="/assets/js/17.c79025e1.js"><link rel="prefetch" href="/assets/js/18.959ecd03.js"><link rel="prefetch" href="/assets/js/19.9b33ed18.js"><link rel="prefetch" href="/assets/js/20.ef228a5b.js"><link rel="prefetch" href="/assets/js/21.95b935c1.js"><link rel="prefetch" href="/assets/js/22.6089ec44.js"><link rel="prefetch" href="/assets/js/23.1786dcbd.js"><link rel="prefetch" href="/assets/js/24.1cc8c701.js"><link rel="prefetch" href="/assets/js/25.bfc350ad.js"><link rel="prefetch" href="/assets/js/26.bc869606.js"><link rel="prefetch" href="/assets/js/27.2974731f.js"><link rel="prefetch" href="/assets/js/28.c59ffda1.js"><link rel="prefetch" href="/assets/js/29.a4f4f78c.js"><link rel="prefetch" href="/assets/js/3.b306ebdc.js"><link rel="prefetch" href="/assets/js/30.f86e1c24.js"><link rel="prefetch" href="/assets/js/31.3a368f51.js"><link rel="prefetch" href="/assets/js/32.ae32716d.js"><link rel="prefetch" href="/assets/js/33.04577fe2.js"><link rel="prefetch" href="/assets/js/34.0036621d.js"><link rel="prefetch" href="/assets/js/35.ae9cca52.js"><link rel="prefetch" href="/assets/js/36.46328e65.js"><link rel="prefetch" href="/assets/js/37.b265ca29.js"><link rel="prefetch" href="/assets/js/38.30e09b09.js"><link rel="prefetch" href="/assets/js/39.b34ea9f8.js"><link rel="prefetch" href="/assets/js/4.1b3f0ff6.js"><link rel="prefetch" href="/assets/js/40.6ee002ae.js"><link rel="prefetch" href="/assets/js/41.fc420cf4.js"><link rel="prefetch" href="/assets/js/42.209ec249.js"><link rel="prefetch" href="/assets/js/43.2d7d1cd7.js"><link rel="prefetch" href="/assets/js/44.b9fd8430.js"><link rel="prefetch" href="/assets/js/45.15ab68bd.js"><link rel="prefetch" href="/assets/js/46.01b8ec0e.js"><link rel="prefetch" href="/assets/js/47.112cd2f4.js"><link rel="prefetch" href="/assets/js/48.867e58b9.js"><link rel="prefetch" href="/assets/js/49.3ac37d3e.js"><link rel="prefetch" href="/assets/js/5.784f0707.js"><link rel="prefetch" href="/assets/js/50.f9dae8e2.js"><link rel="prefetch" href="/assets/js/51.43768ca2.js"><link rel="prefetch" href="/assets/js/52.dde625a3.js"><link rel="prefetch" href="/assets/js/53.72d8e143.js"><link rel="prefetch" href="/assets/js/54.bc802a1c.js"><link rel="prefetch" href="/assets/js/55.e1f55ab2.js"><link rel="prefetch" href="/assets/js/56.1118b442.js"><link rel="prefetch" href="/assets/js/57.c6e74a85.js"><link rel="prefetch" href="/assets/js/58.cfab71d0.js"><link rel="prefetch" href="/assets/js/59.6fb84388.js"><link rel="prefetch" href="/assets/js/6.a94e70e9.js"><link rel="prefetch" href="/assets/js/60.f130f013.js"><link rel="prefetch" href="/assets/js/61.99515c03.js"><link rel="prefetch" href="/assets/js/62.d3e48f49.js"><link rel="prefetch" href="/assets/js/7.8a7612b0.js"><link rel="prefetch" href="/assets/js/9.8e900de4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f78ef515.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/LogoHB.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Liste des cours</a></li><li><a href="/general/" class="sidebar-link">Culture numérique</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/git/" class="sidebar-heading clickable"><span>Git</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/linux/" class="sidebar-link">Linux</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/php/" class="sidebar-heading clickable"><span>PHP</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/symfony/" class="sidebar-heading clickable"><span>Symfony</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js/" class="sidebar-heading clickable"><span>Javascript</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/lamp/" class="sidebar-link">Serveur Lamp</a></li><li><a href="/deploy/" class="sidebar-link">Déploiement</a></li><li><a href="/docker/" class="sidebar-link">Docker</a></li><li><a href="/ci/" aria-current="page" class="active sidebar-link">Intégration continue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#pre-requis" class="sidebar-link">Pré-requis</a></li><li class="sidebar-sub-header"><a href="/ci/#definitions" class="sidebar-link">Définitions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#devops" class="sidebar-link">DevOps</a></li><li class="sidebar-sub-header"><a href="/ci/#deploiement-continu" class="sidebar-link">Déploiement continu</a></li><li class="sidebar-sub-header"><a href="/ci/#integration-continue-2" class="sidebar-link">Intégration continue</a></li><li class="sidebar-sub-header"><a href="/ci/#docker" class="sidebar-link">Docker</a></li><li class="sidebar-sub-header"><a href="/ci/#d-autres-outils-utiles" class="sidebar-link">D'autres outils utiles</a></li></ul></li><li class="sidebar-sub-header"><a href="/ci/#gitlab-et-github" class="sidebar-link">GitLab et GitHub</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#revue-de-code" class="sidebar-link">Revue de code</a></li></ul></li><li class="sidebar-sub-header"><a href="/ci/#ci-cd-avec-gitlab" class="sidebar-link">CI / CD avec GitLab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#un-exemple" class="sidebar-link">Un exemple</a></li><li class="sidebar-sub-header"><a href="/ci/#configuration-du-fichier-de-ci" class="sidebar-link">Configuration du fichier de CI</a></li><li class="sidebar-sub-header"><a href="/ci/#pipelines" class="sidebar-link">Pipelines</a></li><li class="sidebar-sub-header"><a href="/ci/#les-runners" class="sidebar-link">Les runners</a></li><li class="sidebar-sub-header"><a href="/ci/#taches-jobs" class="sidebar-link">Tâches / jobs</a></li></ul></li><li class="sidebar-sub-header"><a href="/ci/#ci-cd-avec-github" class="sidebar-link">CI / CD avec GitHub</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#un-workflow-basique" class="sidebar-link">Un Workflow basique</a></li><li class="sidebar-sub-header"><a href="/ci/#utiliser-des-conteneurs-docker" class="sidebar-link">Utiliser des conteneurs Docker</a></li><li class="sidebar-sub-header"><a href="/ci/#partager-des-fichiers" class="sidebar-link">Partager des fichiers</a></li><li class="sidebar-sub-header"><a href="/ci/#aller-plus-loin" class="sidebar-link">Aller plus loin</a></li></ul></li><li class="sidebar-sub-header"><a href="/ci/#exercice-ci-de-notre-projet-symfony" class="sidebar-link">Exercice - CI de notre projet Symfony</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#les-elements-necessaires-a-notre-ci" class="sidebar-link">Les éléments nécessaires à notre CI</a></li><li class="sidebar-sub-header"><a href="/ci/#des-outils-a-integrer" class="sidebar-link">Des outils à intégrer</a></li></ul></li><li class="sidebar-sub-header"><a href="/ci/#exercice-ci-avec-gitlab" class="sidebar-link">Exercice - CI avec GitLab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ci/#utilisation-des-bases" class="sidebar-link">Utilisation des bases</a></li><li class="sidebar-sub-header"><a href="/ci/#ajout-de-docker" class="sidebar-link">Ajout de Docker</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="integration-continue"><a href="#integration-continue" class="header-anchor">#</a> Intégration continue</h1> <h2 id="pre-requis"><a href="#pre-requis" class="header-anchor">#</a> Pré-requis</h2> <ul><li>Git</li> <li>GitLab / GitHub / Bitbucket / équivalent</li> <li>Yaml (<a href="https://www.codeproject.com/Articles/1214409/Learn-YAML-in-five-minutes" target="_blank" rel="noopener noreferrer">apprendre le YAML en 5 minutes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li></ul> <h2 id="definitions"><a href="#definitions" class="header-anchor">#</a> Définitions</h2> <p>L'introduction en vidéo :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/85edd5f003384961baa88d784ef2ca9c" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <h3 id="devops"><a href="#devops" class="header-anchor">#</a> DevOps</h3> <p>Le DevOps est une pratique technique, visant à unifier le développement (logiciel) et l'administration système (gestion des serveurs).</p> <p>Dans les faits, on parle de DevOps à la fois pour la pratique et comme métier/spécialisation. Dans les deux cas, il s'agit de mettre en place divers outils, permettant de s'assurer de la qualité du produit et du respect du cahier des charges au fur et à mesure du développement.</p> <p>En pratique, cela implique :</p> <ul><li>des cycles de développement courts</li> <li>un travail d'équipe (relecture du code et mise en place de pratiques communes)</li> <li>la mise en place, dès le départ, de tests, d'outils de vérification de la qualité du code ou de la performance, etc. et leur automatisation</li> <li>la mise en place d'environnements de travail au plus près de l'environnement de production (et lancement des outils automatisés dans ce contexte)</li> <li>des mises à disposition (déploiement) très régulières, que ce soit pour des tests ou en production</li> <li>la surveillance du fonctionnement et de la qualité de la production par des métriques définies au plus tôt.</li></ul> <h3 id="deploiement-continu"><a href="#deploiement-continu" class="header-anchor">#</a> Déploiement continu</h3> <p>L'idée du déploiement continu est de livrer les nouvelles fonctionnalités au client dès qu'elles sont disponibles. Pour cela, on déploie les modifications de manière <strong>automatique</strong> dès leur validation (en général par le client sur un autre environnement) ou leur fusion dans la branche principale.</p> <p>On cherche ainsi à améliorer l'application en continu et créer des cycles courts de développement. Chaque déploiement pouvant être annulé facilement (car peu de modification), on évite aussi l'une des grandes contraintes des cycles longs.</p> <h3 id="integration-continue-2"><a href="#integration-continue-2" class="header-anchor">#</a> Intégration continue</h3> <p>L'intégration continue a pour but de vérifier chaque modification du code source, pour éviter les régressions et autres bugs (autant que possible). Un outil d'intégration continue permet de lancer automatiquement diverses actions de vérification du projet (compilation, linters, test unitaires et fonctionnels, etc.) ou toute autre tâche automatisable (cf
déploiement continu 😉 ).</p> <p>Pour utiliser des outils d'intégration continue, il faut que :</p> <ul><li>le code soit versionné (git, svn, etc.)</li> <li>des outils de vérification automatiques existent dans le projet (compilation, tests, etc.)</li></ul> <p>Si on souhaite mettre en place du déploiement continu (avec ou sans intégration continue), il faut que :</p> <ul><li>le projet puisse être mis sur un serveur / sa machine de destination</li> <li>des outils de déploiement aient été mis en place</li></ul> <h4 id="outils-d-integration-continue"><a href="#outils-d-integration-continue" class="header-anchor">#</a> Outils d'intégration continue</h4> <ul><li><a href="https://www.jenkins.io/" target="_blank" rel="noopener noreferrer">Jenkins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://travis-ci.com/" target="_blank" rel="noopener noreferrer">TravisCI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://cruisecontrol.sourceforge.net/" target="_blank" rel="noopener noreferrer">CruiseControl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>mais aussi <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://bitbucket.org/product/fr/features/pipelines" target="_blank" rel="noopener noreferrer">Bitbucket Pipelines<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ou <a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noopener noreferrer">GitLab CI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Nous allons nous concentrer sur les <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et <a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noopener noreferrer">GitLab CI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, qui sont plutôt simples à utiliser et plus rapides à mettre en place (en plus d'avoir une logique similaire).</p> <h3 id="docker"><a href="#docker" class="header-anchor">#</a> Docker</h3> <p>Docker est un logiciel libre permettant de lancer des applications dans des conteneurs, ayant des tâches spécifiques (en général, chaque conteneur permet de lancer 1 programme précis, avec ses dépendances directes).</p> <p>Contrairement à la virtualisation, qui reproduit toutes les caractéristiques d'une machine, la conteneurisation s'appuie sur certaines parties de la machine hôte (dont le système d'exploitation) pour fonctionner (ce qui améliore grandement la compatibilité et la flexibilité). Un autre intérêt est de séparer complètement l'exécution des différents services nécessaires à une application (BdD, serveur, etc.), les lançant dans des processus séparés.</p> <p>Pour plus d'informations sur le sujet, vous pouvez consulter <a href="/docker/">le cours sur Docker, sur ce site</a>.</p> <h3 id="d-autres-outils-utiles"><a href="#d-autres-outils-utiles" class="header-anchor">#</a> D'autres outils utiles</h3> <ul><li><a href="https://gitlab.com/xavki/sommaire-xavki-tutos-fr" target="_blank" rel="noopener noreferrer">Un grand ensemble de tuto DevOps par Xavki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://phpstan.org/" target="_blank" rel="noopener noreferrer">Un outil d'analyse statique pour Php<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.atlassian.com/fr/git/tutorials/comparing-workflows/gitflow-workflow" target="_blank" rel="noopener noreferrer">Git workflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank" rel="noopener noreferrer">Ansible<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (automatisation de tâches et gestion d'états)</li></ul> <h2 id="gitlab-et-github"><a href="#gitlab-et-github" class="header-anchor">#</a> <a href="https://www.gitlab.com" target="_blank" rel="noopener noreferrer">GitLab<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et <a href="https://www.github.com" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Une présentation de GitLab et GitHub en vidéo :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/294683a858734af694d4b2edcb68d4c5" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <p>Bien que tout ce qui suit s'applique aussi bien à Bitbucket, la syntaxe et les denominations changent d'un outil à l'autre. Les concepts restent les mêmes et il est plutôt aisé d'adapter ce que vous verrez ici à d'autres outils de CI/CD.</p> <p>GitLab et GitHub sont des gestionnaires de repositories git en ligne. Ils peuvent servir, entre autre, de :</p> <ul><li>gestionnaire de tickets</li> <li>d'outils de revue de code</li> <li>plateforme de CI/CD</li></ul> <p>Nous allons nous baser sur Git et ses mécaniques, voici quelques resources pouvant être utiles pour le maîtriser :</p> <ul><li><a href="https://about.gitlab.com/images/press/git-cheat-sheet.pdf" target="_blank" rel="noopener noreferrer">Git Cheat Sheet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (ou <a href="https://github.github.com/training-kit/downloads/fr/github-git-cheat-sheet.pdf" target="_blank" rel="noopener noreferrer">en Français<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li><a href="https://git-scm.com/docs" target="_blank" rel="noopener noreferrer">la documentation officielle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>une <a href="https://www.atlassian.com/fr/git/tutorials/learn-git-with-bitbucket-cloud" target="_blank" rel="noopener noreferrer">documentation Bitbucket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> assez complète et en français</li></ul> <h3 id="revue-de-code"><a href="#revue-de-code" class="header-anchor">#</a> Revue de code</h3> <p>L'un des grands intérêts de travailler avec Git (en plus d'avoir un code versionné) est de faciliter le travail collaboratif, grâce notamment aux revues de code.</p> <p>Mais <strong>pourquoi relire le code d'un autre dev ?</strong></p> <ul><li>Vérifier que la demande initiale est respectée</li> <li>Que le code produit répond aux <strong>bonnes pratiques communes</strong></li> <li>Avoir un second (ou troisième, quatrième, etc.) point de vue sur le travail effectué et trouver d'éventuels bugs avant qu'ils ne se dévoilent au client.</li></ul> <p>Cette revue de code se fait en général dans les Merge/Pull Requests (MR ou PR) du projet.</p> <h2 id="ci-cd-avec-gitlab"><a href="#ci-cd-avec-gitlab" class="header-anchor">#</a> CI / CD avec GitLab</h2> <p>La <a href="https://docs.gitlab.com/ee/ci/introduction/index.html" target="_blank" rel="noopener noreferrer">documentation officielle de GitLab<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> à laquelle je vais beaucoup me référer.</p> <p>Pour se faire, notre principal outil va être le fichier <code>.gitlab-ci.yml</code>. C'est dans ce fichier que nous allons définir nos tâches (<code>jobs</code>) et nos étapes (<code>stages</code>).</p> <ul><li>L'ensemble des étapes forment ce qu'on appelle un <code>Pipeline</code>.</li> <li>Les étapes contiennent des tâches. Ce sont des commandes (actions) que l'on va faire lancer à notre serveur (GitLab).</li> <li>Les tâches sont exécutées par des <code>runners</code></li></ul> <h3 id="un-exemple"><a href="#un-exemple" class="header-anchor">#</a> Un exemple</h3> <p>Un exemple de Workflow que nous pouvons construire :</p> <p><img src="https://docs.gitlab.com/ee/ci/introduction/img/gitlab_workflow_example_11_9.png" alt="Un Workflow GitLab : depuis une nouvelle branche, on lance les actions automatiques jusqu'au merge, qui déclenche d'autres actions automatiques"></p> <p>La version plus détaillée :</p> <p><img src="https://docs.gitlab.com/ee/ci/introduction/img/gitlab_workflow_example_extended_v12_3.png" alt="Un Workflow GitLab : depuis une nouvelle branche, on lance les actions automatiques jusqu'au merge, qui déclenche d'autres actions automatiques"></p> <p>Que se passe-t-il dans ces images :</p> <ul><li>Un développeur crée une branche et crée plusieurs changements (des commits)</li> <li>Dès que le serveur reçoit ses commits (push), un pipeline est lancé
<ul><li>ce pipeline contient un ensemble d'étapes (stages) qui doivent être validées pour passer à la suivante</li> <li>chaque étape définit plusieurs tâches à exécuter et, dans notre exemple, certaines tâches créent une erreur</li></ul></li> <li>Le pipeline renvoie une erreur</li> <li>Le développeur crée plusieurs commits pour corriger les différents problèmes et les push</li> <li>Un nouveau pipeline est lancé</li> <li>Cette fois, tout fonctionne. L'une des tâches est le déploiement d'une Review App, c’est-à-dire le déploiement d'un site permettant de tester la branche, dans des conditions réelles (très utile pour le reviewer de la Merge Request 😉 ).</li> <li>Un(e) autre membre de l'équipe relit et teste le code du développeur et approuve sa Merge Request</li> <li>La Merge Request est fusionnée</li> <li>Un nouveau pipeline est lancé
<ul><li>si le projet fait de la livraison continue (<em>Continuous Delivery</em>), une tâche peut être lancée (manuellement) pour mettre l'application en production</li> <li>si le projet fait du déploiement continue (<em>Continuous Deployment</em>), cette tâche est lancée automatiquement</li></ul></li></ul> <h3 id="configuration-du-fichier-de-ci"><a href="#configuration-du-fichier-de-ci" class="header-anchor">#</a> Configuration du fichier de CI</h3> <p><a href="https://blog.eleven-labs.com/fr/introduction-gitlab-ci/" target="_blank" rel="noopener noreferrer">Mon pense-bête favori<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, par Nicolas Grévin de Eleven Labs</p> <p>Son nom et son emplacement sont standard : <code>.gitlab-ci.yml</code> à la racine du projet Sur GitLab, vous pouvez modifier cela dans : <code>Settings (menu de gauche) &gt; CI/CD &gt; General pipelines &gt; Custom CI config path</code></p> <p>Toutefois, je vous conseille de garder la configuration de base, c'est ce qui est attendu par beaucoup de développeurs.</p> <p>Un exemple de fichier <code>.gitlab-ci.yml</code> (celui utilisé par ce site) :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Pour réaliser ce fichier, je me suis basé sur le tuto d'Eleven Labs : </span>
<span class="token comment"># https://blog.eleven-labs.com/fr/introduction-gitlab-ci/</span>

<span class="token comment"># On définit les différentes étapes (stages) à faire tourner dans le pipeline</span>
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token comment"># cette étape (stage) va compiler l'application, </span>
  <span class="token comment"># permettant de vérifier qu'il n'y ait pas d'erreur dès la compilation</span>
  <span class="token punctuation">-</span> build
  <span class="token comment"># Déploie l'application sur le serveur approprié, si nécessaire</span>
  <span class="token punctuation">-</span> deploy

<span class="token comment"># On définit une tâche (job) qui pourra être lancée lors d'un stage</span>
<span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token comment"># Ce job sera exécuté lors du stage build</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token comment"># On va lancer ce job dans un container Docker. </span>
  <span class="token comment"># Ici, une image nodejs de chez Drakona, en version 14 (utilisant Alpine)</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> drakona/node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine
  <span class="token comment"># On met certains dossiers en cache, pour les conserver d'une exécution à l'autre</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token comment"># Ici, on garde le dossier node_modules, </span>
      <span class="token comment"># afin de ne pas re-télécharger toutes les dépendances à chaque fois</span>
      <span class="token punctuation">-</span> node_modules/
  <span class="token comment"># Le script que va utiliser ce job. Ici, on profite de notre Makefile !</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> make update build
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> public
  <span class="token comment"># Des tags pour déterminer quel runner va exécuter la tâche.</span>
  <span class="token comment"># Ici, c'est une configuration personnalisée, pour notre GitLab.</span>
  <span class="token comment"># Nous avons créé nos propres runners</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token comment"># Pour cette tâche, nous allons utiliser un runner utilisant Docker</span>
    <span class="token comment"># Dans notre cas, il y a 6 runners répondant à ce tag</span>
    <span class="token comment"># Et c'est le premier disponible qui l'exécutera.</span>
    <span class="token punctuation">-</span> docker

<span class="token comment"># Un autre job, qui va déployer notre application sur le serveur de prod</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token comment"># Avant d'exécuter le script, on va faire un ensemble de commandes,</span>
  <span class="token comment"># pour avoir une clé SSH valide et prête à l'emploi</span>
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token comment"># On s'assure que openssh est installé</span>
    <span class="token punctuation">-</span> <span class="token string">'command -v ssh-agent &gt;/dev/null || ( apt-get update -y &amp;&amp; apt-get install openssh-client -y )'</span>
    <span class="token comment"># On lance le client SSH</span>
    <span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
    <span class="token comment"># On va chercher la variable d'environnement DEPLOY_SK, définie dans GitLab</span>
    <span class="token comment"># et qui contient une clé privée que l'on va utiliser pour le déploiement</span>
    <span class="token punctuation">-</span> echo &quot;$DEPLOY_SK&quot; <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">|</span> ssh<span class="token punctuation">-</span>add <span class="token punctuation">-</span>
    <span class="token comment"># On s'assure d'avoir un dossier .ssh et qu'il ait des droits corrects</span>
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
  <span class="token comment"># Ce job se lance lors du stage deploy</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token comment"># Le script à exécuter</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span> make deploy
  <span class="token comment"># Ce déploiement n'a lieu que si l'on fait une action sur main </span>
  <span class="token comment"># (commit, push, merge, etc.)</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> main
</code></pre></div><h3 id="pipelines"><a href="#pipelines" class="header-anchor">#</a> Pipelines</h3> <p>Par défaut, un pipeline est lancé dès qu'un nouveau commit est poussé (push) sur GitLab (si vous en poussez plusieurs dans la même branche, un seul pipeline sera lancé, sur le dernier commit).</p> <p>Vous pouvez voir les pipelines directement dans la partie <code>CI/CD</code> de votre repository, mais ils sont plus pratiques à d'autres emplacements de l'interface.</p> <p>Sur la partie <code>Project Overview</code> :</p> <p><img src="/assets/img/ci/ci-pipeline-overview.png" alt=""></p> <p>Sur la liste des Merge Requests :</p> <p><img src="/assets/img/ci/ci-pipeline-mr.png" alt=""></p> <p>Ou sur une <code>Merge Request</code> :</p> <p><img src="/assets/img/ci/ci-pipeline-mr2.png" alt=""></p> <p>C'est sur ce dernier affichage que vous pouvez avoir l'adresse pour une <a href="https://docs.gitlab.com/ee/ci/review_apps/" target="_blank" rel="noopener noreferrer">Review App<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, qui est le lien entre une branche de votre repository et un <a href="https://docs.gitlab.com/ee/ci/environments/index.html" target="_blank" rel="noopener noreferrer">environnement<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (un serveur permettant de tester cette branche, en somme).</p> <p><a href="https://docs.gitlab.com/ee/ci/review_apps/" target="_blank" rel="noopener noreferrer">La documentation officielle sur les Review App<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et <a href="https://docs.gitlab.com/ee/ci/environments/index.html" target="_blank" rel="noopener noreferrer">celle sur les environnements<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="les-runners"><a href="#les-runners" class="header-anchor">#</a> Les runners</h3> <p>Pour lancer les tâches, GitLab utilise des programmes indépendants, les <code>runners</code>. GitLab fourni de nombreux runners et vous permet éventuellement d'en créer vous-même, en quelques lignes de commande.</p> <p>Il y a 4 grands types de runners, disponibles par défaut :</p> <ul><li>shell (la ligne de commande du serveur)</li> <li>ssh (on exécute nos commandes <em>via</em> SSH sur un autre serveur)</li> <li>docker (on exécute nos commandes dans un container Docker)</li> <li>Kubernetes (on exécute nos commandes dans un environnement Kubernetes)</li></ul> <p>⚠️ Conseil gitlab.com : toujours utiliser docker (avec le tag <code>gitlab-org-docker</code> et une image Docker sur vos tâches, à moins que vous ne codiez en Ruby 😉 ).</p> <h3 id="taches-jobs"><a href="#taches-jobs" class="header-anchor">#</a> Tâches / jobs</h3> <p>Une tâche doit toujours lancer un ou des scripts (commandes à exécuter), tout le reste est optionnel. De nombreuses options permettent de personnaliser les conditions de lancement de la tâche, les pré-requis, etc. Les différentes options des tâches :</p> <ul><li>script : déclaration obligatoire, contenant les commandes à exécuter</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> make update
    <span class="token punctuation">-</span> make build
</code></pre></div><ul><li>before_script ou after_script : permet d'exécuter une ou des commandes avant ou après le script de notre tâche. Vous pouvez également les définir pour toutes vos tâches, en les précisant à la racine</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">before_script</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> echo &quot;avant tous les scripts<span class="token punctuation">,</span> sauf si un before script est défini dans une tâche&quot;

<span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo &quot;avant script&quot;
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> make update
    <span class="token punctuation">-</span> make build
  <span class="token key atrule">after_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo &quot;après script&quot;
</code></pre></div><ul><li>image : nom d'une image Docker à utiliser pour exécuter la tâche. Peut être écrit à la racine pour l'exécution de toutes les tâches.</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># toutes les tâches seront exécutées dans des conteneurs nodejs, en version 12</span>
<span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span><span class="token number">12</span>

<span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token comment"># Cette tâche sera exécutée dans un conteneur php-fpm</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> php<span class="token punctuation">:</span>fpm
</code></pre></div><ul><li>services : permet d'ajouter des conteneurs Docker pour aider dans les tâches (associer une BdD par exemple)</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> php<span class="token punctuation">:</span>fpm
  <span class="token comment"># On appelle le service postgres pour accéder à une BdD</span>
  <span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> postgres
</code></pre></div><ul><li>stages : permet de regrouper les tâches dans des étapes :</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Déclaration des différentes étapes disponibles</span>
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> deploy
  
<span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token comment"># la tâche pages est dans l'étape build</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
<span class="token comment">#...</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token comment"># la tâche deploy est dans l'étape deploy</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
</code></pre></div><ul><li>only et except : définition de contraintes d'exécution d'une tâche. <code>only</code> peut, par exemple, préciser qu'on ne lancera la tâche que lors d'un <em>push sur master</em>, <code>except</code> que si le push à lieu sur <em>une branche autre que master</em></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">deploy-master</span><span class="token punctuation">:</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span> make deploy
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master <span class="token comment"># Le job sera effectué uniquement lors d’un événement sur la branche master</span>

<span class="token key atrule">test-not-master</span><span class="token punctuation">:</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span> make test
  <span class="token key atrule">except</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master <span class="token comment"># Le job sera effectué sur toutes les branches lors d’un événement sauf sur la branche master</span>

</code></pre></div><ul><li>cache : Mettre des fichiers et des répertoires en cache et qui seront disponible dans le pipeline (ils sont détruits après l'exécution du pipeline, que ce soit un succès ou non)</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">push-cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span> make cache
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token comment"># Chemin des fichiers et dossiers à conserver</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> cache <span class="token comment"># répertoire mis en cache</span>
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> push <span class="token comment"># On précise qu'on ajoute au cache</span>

<span class="token key atrule">pull-cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span> make somethingWithCache
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> build
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> pull <span class="token comment"># récupération du dossier build dans le cache</span>
</code></pre></div><p>Et beaucoup d'autres, que je vous invite <a href="https://blog.eleven-labs.com/fr/introduction-gitlab-ci/" target="_blank" rel="noopener noreferrer">à découvrir ici<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 😉</p> <h2 id="ci-cd-avec-github"><a href="#ci-cd-avec-github" class="header-anchor">#</a> CI / CD avec GitHub</h2> <p>L'<a href="https://docs.github.com/en/actions/learn-github-actions" target="_blank" rel="noopener noreferrer">introduction officielle aux GitHub Actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, et la vidéo qui va avec :</p> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/cP0I9w2coGU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe> <p>⚠️ L'utilisation de GitHub Actions est limitée et dépend de votre abonnement à GitHub (pour les projets professionnels d'envergure, un abonnement peut être nécessaire, mais pas pour les projets personnels, normalement). Voir <a href="https://docs.github.com/en/actions/reference/usage-limits-billing-and-administration#about-billing-for-github-actions" target="_blank" rel="noopener noreferrer">la documentation officielle sur les limitations de GitHub Actions selon votre abonnement<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="un-workflow-basique"><a href="#un-workflow-basique" class="header-anchor">#</a> Un Workflow basique</h3> <p>Un premier parcours en vidéo de la doc pour expliquer les différents termes et le fonctionnement global de GitHub Actions :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/ef665b2420ad4446bb0955772748497a" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <p>Avec GitHub, on ne parle plus de Pipelines, mais d'Actions. Tout comme avec GitLab, GitHub Actions permet d'exécuter un ensemble de tâches quand un événement se produit sur le repository (distant). Le lexique est toutefois assez différent et il vaut mieux éviter de mélanger.</p> <ul><li>Un <strong>Workflow</strong> est une procédure automatique, décrivant les différents Jobs qui vont être lancés quand un Event se produit,</li> <li>un <strong>Event</strong> (push sur le repository, par exemple) on déclenche un ou plusieurs Jobs,</li> <li>un <strong>Job</strong> contient des Steps,</li> <li>une <strong>Step</strong> contient des actions,</li> <li>une <strong>Action</strong> est un script (une commande) à exécuter.</li></ul> <p>Les Jobs sont exécutés par des <strong>runners</strong> (et peuvent être différents pour chaque Job). Un <strong>runner</strong> lance les différentes actions sur une machine virtuelle (Ubuntu Linux, Microsoft Windows ou macOS). Il est également possible d'utiliser Docker pour lancer nos actions (et nous n'utiliserons que des images officielles).</p> <p><img src="https://docs.github.com/assets/images/help/images/overview-actions-design.png" alt="Un résumé des composants des Actions GitHub"></p> <p>Pour mettre en place des Workflows, il faut créer un ensemble de fichiers <code>.yml</code> dans le dossier <code>.github/workflows/</code> du projet (en local, donc 😉 ). Ces fichiers peuvent être nommé assez librement, mais leur nom doit être toujours en minuscule, et on remplace les espaces par des tirets <code>-</code>.</p> <p>La documentation propose de créer le fichier <code>.github/workflows/learn-github-actions.yml</code>, contenant le code suivant (voir les commentaires pour le détail). Cette commande crée et prépare un environnement nodejs et exécute la commande <code>bats -v</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># On donne un nom à notre Workflow (optionnel). C'est ce nom qui apparaitra sur GitHub</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> learn<span class="token punctuation">-</span>github<span class="token punctuation">-</span>actions
<span class="token comment"># On donne une liste d'événements pour le déclencher</span>
<span class="token comment"># Ici, dès qu'on push sur le repo distant</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">]</span>

<span class="token comment"># On liste les Jobs à effectuer</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
    <span class="token comment"># On a un seul job : check-bats-version qui va préparer un projet nodejs </span>
    <span class="token comment"># et exécuter une commande</span>
    <span class="token key atrule">check-bats-version</span><span class="token punctuation">:</span>
        <span class="token comment"># Ce job est exécuté dans une machine virtuelle Ubuntu</span>
        <span class="token comment"># Dans sa dernière version.</span>
        <span class="token comment"># Pour l'exécuter dans une version précise (disons 19.04), il aurait fallu écrire</span>
        <span class="token comment"># runs-on: ubuntu-19.04</span>
        <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
        <span class="token comment"># On définit les steps (la liste des actions) à exécuter</span>
        <span class="token key atrule">steps</span><span class="token punctuation">:</span>
            <span class="token comment"># On appelle une action déjà définie par la communauté (noter le mot-clé uses)</span>
            <span class="token comment"># Ici, c'est une action qui va récupérer le code (via git clone, a priori) et nous mettre sur la bonne branche</span>
            <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
            <span class="token comment"># Une action pour préparer un environnement nodejs</span>
            <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2
                <span class="token comment"># Avec un paramètre spécifique : on veut la version 14 de nodejs</span>
                <span class="token key atrule">with</span><span class="token punctuation">:</span>
                  <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'14'</span>
            <span class="token comment"># On lance une commande (run) pour installer la librairie bats</span>
            <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install <span class="token punctuation">-</span>g bats
            <span class="token comment"># On lance la commande </span>
            <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> bats <span class="token punctuation">-</span>v
</code></pre></div><p>Il est intéressant de noter, dans l'exemple ce-dessus, l'usage des mots-clés <code>uses</code> et <code>run</code> :</p> <ul><li><a href="https://docs.github.com/en/actions/learn-github-actions/finding-and-customizing-actions" target="_blank" rel="noopener noreferrer"><code>uses</code> va utiliser un autre fichier, définit par la communauté<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (disponible dans les actions de <em>tous</em> les projets) ou par vous-mêmes (voir plus bas), pour exécuter une ou plusieurs commandes (avec d'éventuels paramètres)</li> <li><code>run</code> va exécuter une commande directement</li></ul> <p>Sachez qu'il est également possible d'écrire ses propres actions. N'étant pas expert dans leur écriture, je vous renvoie à <a href="https://docs.github.com/en/actions/creating-actions" target="_blank" rel="noopener noreferrer">la documentation officielle pour la création d'actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Exemple, en vidéo, de mise en place d'un premier Workflow sur un projet Symfony :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/7f140c95606e44d1b68c35f7aaceddf2" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <h3 id="utiliser-des-conteneurs-docker"><a href="#utiliser-des-conteneurs-docker" class="header-anchor">#</a> Utiliser des conteneurs Docker</h3> <p>Il est possible de définir des conteneurs pour exécuter utiliser des services supplémentaires dans les actions ou directement pour exécuter les actions elles-mêmes. Les images à utiliser et leurs configurations sont définies au niveau du Job.
Le but est ici d'ajouter un ensemble de programmes supplémentaires, non présent par défaut dans la machine virtuelle Ubuntu, pour exécuter certaines tâches</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">container-job</span><span class="token punctuation">:</span>
    <span class="token comment"># On conserve une machine virtuelle de base</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    
    <span class="token comment"># Optionnel : on utilise un conteneur créé à partir d'une image php officielle, </span>
    <span class="token comment"># en version 7.4.9. </span>
    <span class="token comment"># Les actions du Job vont être exécutées dans ce conteneur</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> php<span class="token punctuation">:</span>7.4.9

    <span class="token comment"># On fait appel à un ou des services supplémentaires, </span>
    <span class="token comment"># qui vont être lancés dans des conteneurs</span>
    <span class="token key atrule">services</span><span class="token punctuation">:</span>
      <span class="token comment"># On donne un nom à notre service, qu'on utilise dans notre .env </span>
      <span class="token comment"># (c'est l'adresse de la BdD)</span>
      <span class="token key atrule">db</span><span class="token punctuation">:</span>
        <span class="token comment"># On va utiliser l'image mysql (image officielle) en version 5.7</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
        <span class="token comment"># On passe des variables d'environnement, pour configurer notre conteneur</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> pass
          <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> test

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment"># ... On exécute plusieurs étapes nécessaires</span>
      
      <span class="token comment"># On exécute une action pour, par exemple, mettre à jour la BdD</span>
      <span class="token comment"># Attention, notre fichier .env doit avec les bonnes valeurs</span>
      <span class="token comment"># Utilisateur : root</span>
      <span class="token comment"># Mot de passe : pass</span>
      <span class="token comment"># Adresse/IP du serveur : db</span>
      <span class="token comment"># Nom de la base : test</span>
      <span class="token comment"># </span>
      <span class="token comment"># /!\ Mettre à jour ces éléments (dans le CI ou le .env) pour adapter à votre cas !</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create DB
        <span class="token key atrule">run</span><span class="token punctuation">:</span> php bin/console doctrine<span class="token punctuation">:</span>migrations<span class="token punctuation">:</span>migrate <span class="token punctuation">-</span>n
</code></pre></div><p>⚠️ Vous pouvez également <a href="https://docs.github.com/en/actions/creating-actions/dockerfile-support-for-github-actions" target="_blank" rel="noopener noreferrer">créer vos propres images Docker, mais il faut faire attention à plusieurs points<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> importants !</p> <h3 id="partager-des-fichiers"><a href="#partager-des-fichiers" class="header-anchor">#</a> Partager des fichiers</h3> <p>Il est possible, au fur et à mesure de l'exécution de votre Workflow, qu'il faille partager des fichiers, soit entre les jobs, soit en tant que résultat (création d'un fichier <code>.jar</code> par exemple). Il est alors possible de <a href="https://docs.github.com/en/actions/guides/storing-workflow-data-as-artifacts" target="_blank" rel="noopener noreferrer">créer des <strong>artifacts</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (nom donné aux fichiers créés pendant le Workflow), associés à une exécution de votre Workflow et partagé entre plusieurs jobs (voir plusieurs exécutions de votre Workflow !).</p> <p>Pour sauvegarder, on utilise <code>actions/upload-artifact</code> (dans sa version 2, dans l'exemple ci-dessous), qui permet de stocker un fichier sur GitHub</p> <p>Pour récupérer cette sauvegarde, on utilise <code>actions/download-artifact</code> (dans sa version 2, dans l'exemple ci-dessous), qui permet de récupérer des fichiers stockés sur GitHub</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">example-job-with-save</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Save output
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment"># On lance une commande, qui sauvegarde son résultat dans un fichier</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          expr 1 + 1 &gt; output.log</span>
      <span class="token comment"># On savegarde ce fichier sur GitHub, en tant qu'artifact</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload output file
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token comment"># On donne un nom à notre artifact</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> output<span class="token punctuation">-</span>log<span class="token punctuation">-</span>file
          <span class="token comment"># Et un ensemble de fichiers qu'il contient (utiliser Glob ici)</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> output.log
          
  <span class="token key atrule">example-job-with-download</span><span class="token punctuation">:</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment"># On va récupérer un artifact, pour peut être s'en servir plus tard</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download a single artifact
        <span class="token key atrule">needs</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>job<span class="token punctuation">-</span>with<span class="token punctuation">-</span>save
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token comment"># On récupère les fichiers par le nom de l'artifact</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> output<span class="token punctuation">-</span>log<span class="token punctuation">-</span>file
</code></pre></div><p>⚠️ Noter <a href="https://docs.github.com/en/actions/learn-github-actions/managing-complex-workflows#creating-dependent-jobs" target="_blank" rel="noopener noreferrer">l'utilisation du mot-clé <code>needs</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour préciser que le deuxième job a <em>besoin</em> que le premier ait terminé son travail. Ce mot-clé est très utile, du moment que vous avez plusieurs jobs, surtout s'ils dépendent les uns des autres.</p> <h3 id="aller-plus-loin"><a href="#aller-plus-loin" class="header-anchor">#</a> Aller plus loin</h3> <p>Nous avons ici effleuré la surface de tout ce qu'il est possible de faire avec les GitHub Actions et je vous invite à <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">consulter la documentation officielle pour vous faire une idée de toutes les possibilités<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> qu'offre cet outil !</p> <h2 id="exercice-ci-de-notre-projet-symfony"><a href="#exercice-ci-de-notre-projet-symfony" class="header-anchor">#</a> Exercice - CI de notre projet Symfony</h2> <p>Pour notre application Symfony, nous allons créer un Workflow / pipeline pour installer et tester le projet. Nous ajouterons ensuite des outils supplémentaires, que nous ajouterons à notre intégration continue.</p> <h3 id="les-elements-necessaires-a-notre-ci"><a href="#les-elements-necessaires-a-notre-ci" class="header-anchor">#</a> Les éléments nécessaires à notre CI</h3> <ul><li>Récupérer le code (automatique avec GitLab, requiert une Action avec GitHub)</li> <li>Installer les dépendances du projet</li> <li>Créer et initialiser la BdD (migrations + fixtures)</li></ul> <p>Si vous utilisez <strong>GitLab</strong> :</p> <ul><li>Définissez les différentes étapes/stages et les fichiers qu'elles doivent partager</li> <li>définissez et implémentez les tâches/jobs demandées</li></ul> <p>Si vous utiliser <strong>GitHub</strong> :</p> <ul><li>Définissez les différents jobs</li> <li>Définissez les étapes et les actions à effectuer</li> <li>Appelez les actions pré-définies ou créez-en si nécessaire</li></ul> <h3 id="des-outils-a-integrer"><a href="#des-outils-a-integrer" class="header-anchor">#</a> Des outils à intégrer</h3> <p>Une fois que vous disposez d'une intégration continue qui fonctionne, vous êtes prêts à rendre votre code plus beau et d'ajouter des outils de vérification supplémentaire.</p> <p>Je vous invite à jeter un oeil à <a href="https://dev.to/duboiss/symfony-ce-que-j-aurai-aime-savoir-plus-tot-eke" target="_blank" rel="noopener noreferrer">cet article regroupant quelques astuces pouvant être utiles avec Symfony<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" target="_blank" rel="noopener noreferrer">Php CS Fixer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> : outil de vérification de la <strong>forme</strong> du code (attention, on utilise les options <code>--dry-run --diff</code> pour seulement vérifier le code, pas le mettre à jour)</li> <li>Les linters de Symfony, pour vérifier nos fichiers de configuration et nos vues (mais aussi <a href="https://symfony.com/doc/current/translation/lint.html" target="_blank" rel="noopener noreferrer">nos fichiers de traduction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li><a href="https://github.com/phpstan/phpstan" target="_blank" rel="noopener noreferrer">PhpStan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et en particulier <a href="https://github.com/phpstan/phpstan-symfony" target="_blank" rel="noopener noreferrer">PhpStan Symfony<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> : outil d'analyse statique, pour détecter les incohérences du code et trouver des problèmes avant qu'ils ne se produisent. Un conseil : pour corriger les erreurs, commencer au niveau 1 et augmenter petit à petit, jusqu'au niveau 5. Au dela du niveau 5, les erreurs sont bien plus complexes et pénibles à corriger, et vont bien plus loin de ce que vous avez vu de PHP ici.</li></ul> <p>Quelques autres outils, pour les courageux 😉 :</p> <ul><li><a href="https://grafikart.fr/tutoriels/makefile-953" target="_blank" rel="noopener noreferrer">Makefile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://symfony.com/doc/current/testing.html" target="_blank" rel="noopener noreferrer">PhpUnit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ou Selenium pour des tests unitaires et/ou fonctionnels (si vous en avez, sinon c'est l'occasion de tester 😉 )</li> <li>Si votre projet utilise npm :
<ul><li>lancer l'installation des paquets</li> <li>utiliser les commandes nécessaires au fonctionnement du projet (compilation des fichiers Sass, appel à Webpack, etc.)</li></ul></li></ul> <h2 id="exercice-ci-avec-gitlab"><a href="#exercice-ci-avec-gitlab" class="header-anchor">#</a> Exercice - CI avec GitLab</h2> <h3 id="utilisation-des-bases"><a href="#utilisation-des-bases" class="header-anchor">#</a> Utilisation des bases</h3> <p>Dans un premier temps, nous allons créer une intégration continue fictive, avec des echos comme scripts.</p> <p>Dans une nouvelle branche Git, construire un pipeline respectant les consignes suivantes (les scripts sont indiqués entre parenthèses) :</p> <ul><li><p>des tâches</p> <ul><li>composer (<code>echo 'composer install'</code>)</li> <li>database (<code>echo &quot;création d'une BdD et exécution des migrations et fixtures&quot;</code>)</li> <li>tests unitaires (<code>echo 'tests unitaires'</code>)</li> <li>tests fonctionnels (<code>echo 'tests fonctionnels'</code>)</li> <li>déploiement prod (<code>echo 'déploiement prod'</code>), uniquement sur la branche main / master (votre branche principale) et à déclencher manuellement (ne doit pas être lancée automatiquement)</li> <li>déploiement démo (<code>echo 'déploiement démo'</code>), uniquement sur la branche principale</li> <li>déploiement App Review (<code>echo 'déploiement app review'</code>), sur les branches autres que votre branche principale</li></ul></li> <li><p>des étapes :</p> <ul><li><code>build</code> qui contiendra les tâches <code>composer</code> et <code>database</code></li> <li><code>test</code> qui contiendra les tâches de tests unitaires et fonctionnels</li> <li><code>deploy</code> qui contiendra les tâches de déploiement (prod, démo et App Review)</li></ul></li></ul> <p>Pour tester votre pipeline, faites un push de cette branche 😉 .</p> <p>Question supplémentaire, nécessaire pour la suite : comment faire en sorte de ne pas avoir à faire un <code>composer install</code> et de mettre en place la BdD pour chaque tâche ?</p> <h3 id="ajout-de-docker"><a href="#ajout-de-docker" class="header-anchor">#</a> Ajout de Docker</h3> <p>Maintenant, nous allons mettre en place des scripts réels. Pour cela, nous allons également utiliser 2 images Docker :</p> <ul><li><p><code>drakona/php:7.4-symfony</code> en tant qu'image pour toutes nos tâches</p></li> <li><p><code>mysql:5.7</code> en tant que service, pour obtenir une BdD</p></li> <li><p>Comment configurer MySQL ? (voir documentation de l'image mysql sur DockerHub)</p></li> <li><p>Comment avoir la bonne configuration dans le fichier <code>.env</code> pendant le pipeline ?</p></li> <li><p>Ajouter les scripts réels :</p> <ul><li>la tâche <code>composer</code> doit lancer un <code>composer install</code></li> <li>la tâche <code>database</code> doit lancer les migrations et les fixtures</li></ul></li></ul> <p>Pour le moment, les autres tâches vont continuer à faire des <code>echo</code></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docker/" class="prev">
        Docker
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a0283a3d.js" defer></script><script src="/assets/js/2.2bb1f65b.js" defer></script><script src="/assets/js/8.82725242.js" defer></script>
  </body>
</html>
