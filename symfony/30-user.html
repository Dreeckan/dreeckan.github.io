<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Connexion et sécurisation</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Les formations de Rémi Jarjat pour Human Booster">
    
    <link rel="preload" href="/assets/css/0.styles.f78ef515.css" as="style"><link rel="preload" href="/assets/js/app.a0283a3d.js" as="script"><link rel="preload" href="/assets/js/2.2bb1f65b.js" as="script"><link rel="preload" href="/assets/js/52.dde625a3.js" as="script"><link rel="prefetch" href="/assets/js/10.a27b6e9d.js"><link rel="prefetch" href="/assets/js/11.2193e9e3.js"><link rel="prefetch" href="/assets/js/12.f39a5b44.js"><link rel="prefetch" href="/assets/js/13.2d6a44aa.js"><link rel="prefetch" href="/assets/js/14.0673e9ad.js"><link rel="prefetch" href="/assets/js/15.a5eeeada.js"><link rel="prefetch" href="/assets/js/16.33dfc880.js"><link rel="prefetch" href="/assets/js/17.c79025e1.js"><link rel="prefetch" href="/assets/js/18.959ecd03.js"><link rel="prefetch" href="/assets/js/19.9b33ed18.js"><link rel="prefetch" href="/assets/js/20.ef228a5b.js"><link rel="prefetch" href="/assets/js/21.95b935c1.js"><link rel="prefetch" href="/assets/js/22.6089ec44.js"><link rel="prefetch" href="/assets/js/23.1786dcbd.js"><link rel="prefetch" href="/assets/js/24.1cc8c701.js"><link rel="prefetch" href="/assets/js/25.bfc350ad.js"><link rel="prefetch" href="/assets/js/26.bc869606.js"><link rel="prefetch" href="/assets/js/27.2974731f.js"><link rel="prefetch" href="/assets/js/28.c59ffda1.js"><link rel="prefetch" href="/assets/js/29.a4f4f78c.js"><link rel="prefetch" href="/assets/js/3.b306ebdc.js"><link rel="prefetch" href="/assets/js/30.f86e1c24.js"><link rel="prefetch" href="/assets/js/31.3a368f51.js"><link rel="prefetch" href="/assets/js/32.ae32716d.js"><link rel="prefetch" href="/assets/js/33.04577fe2.js"><link rel="prefetch" href="/assets/js/34.0036621d.js"><link rel="prefetch" href="/assets/js/35.ae9cca52.js"><link rel="prefetch" href="/assets/js/36.46328e65.js"><link rel="prefetch" href="/assets/js/37.b265ca29.js"><link rel="prefetch" href="/assets/js/38.30e09b09.js"><link rel="prefetch" href="/assets/js/39.b34ea9f8.js"><link rel="prefetch" href="/assets/js/4.1b3f0ff6.js"><link rel="prefetch" href="/assets/js/40.6ee002ae.js"><link rel="prefetch" href="/assets/js/41.fc420cf4.js"><link rel="prefetch" href="/assets/js/42.209ec249.js"><link rel="prefetch" href="/assets/js/43.2d7d1cd7.js"><link rel="prefetch" href="/assets/js/44.b9fd8430.js"><link rel="prefetch" href="/assets/js/45.15ab68bd.js"><link rel="prefetch" href="/assets/js/46.01b8ec0e.js"><link rel="prefetch" href="/assets/js/47.112cd2f4.js"><link rel="prefetch" href="/assets/js/48.867e58b9.js"><link rel="prefetch" href="/assets/js/49.3ac37d3e.js"><link rel="prefetch" href="/assets/js/5.784f0707.js"><link rel="prefetch" href="/assets/js/50.f9dae8e2.js"><link rel="prefetch" href="/assets/js/51.43768ca2.js"><link rel="prefetch" href="/assets/js/53.72d8e143.js"><link rel="prefetch" href="/assets/js/54.bc802a1c.js"><link rel="prefetch" href="/assets/js/55.e1f55ab2.js"><link rel="prefetch" href="/assets/js/56.1118b442.js"><link rel="prefetch" href="/assets/js/57.c6e74a85.js"><link rel="prefetch" href="/assets/js/58.cfab71d0.js"><link rel="prefetch" href="/assets/js/59.6fb84388.js"><link rel="prefetch" href="/assets/js/6.a94e70e9.js"><link rel="prefetch" href="/assets/js/60.f130f013.js"><link rel="prefetch" href="/assets/js/61.99515c03.js"><link rel="prefetch" href="/assets/js/62.d3e48f49.js"><link rel="prefetch" href="/assets/js/7.8a7612b0.js"><link rel="prefetch" href="/assets/js/8.82725242.js"><link rel="prefetch" href="/assets/js/9.8e900de4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f78ef515.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/LogoHB.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Liste des cours</a></li><li><a href="/general/" class="sidebar-link">Culture numérique</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/git/" class="sidebar-heading clickable"><span>Git</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/linux/" class="sidebar-link">Linux</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/php/" class="sidebar-heading clickable"><span>PHP</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/symfony/" class="sidebar-heading clickable router-link-active open"><span>Symfony</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/symfony/01-installation.html" class="sidebar-link">Installer Symfony et son environnement de travail</a></li><li><a href="/symfony/10-structure.html" class="sidebar-link">Structure et utilisation d'un projet</a></li><li><a href="/symfony/20-routing.html" class="sidebar-link">Le routing</a></li><li><a href="/symfony/21-controllers.html" class="sidebar-link">Les controllers</a></li><li><a href="/symfony/22-twig.html" class="sidebar-link">Twig</a></li><li><a href="/symfony/23-injection.html" class="sidebar-link">Les services et l'injection de dépendances</a></li><li><a href="/symfony/24-doctrine.html" class="sidebar-link">Doctrine et la BdD</a></li><li><a href="/symfony/25-formulaires.html" class="sidebar-link">Formulaires</a></li><li><a href="/symfony/26-translation.html" class="sidebar-link">Les traductions</a></li><li><a href="/symfony/27-event-listeners.html" class="sidebar-link">Event listeners/subscribers</a></li><li><a href="/symfony/30-user.html" aria-current="page" class="active sidebar-link">Connexion et sécurisation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/symfony/30-user.html#pour-resumer" class="sidebar-link">Pour résumer</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#installation-et-preparation" class="sidebar-link">Installation et préparation</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#connecter-un-utilisateur" class="sidebar-link">Connecter un utilisateur</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#utiliser-les-droits" class="sidebar-link">Utiliser les droits</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/symfony/30-user.html#security-yaml" class="sidebar-link">Security.yaml</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#isgranted-et-is-granted" class="sidebar-link">IsGranted() et is_granted()</a></li></ul></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#recuperer-le-user-connecte" class="sidebar-link">Récupérer le User connecté</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/symfony/30-user.html#dans-un-controleur" class="sidebar-link">Dans un contrôleur</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#dans-un-service" class="sidebar-link">Dans un service</a></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#dans-un-template" class="sidebar-link">Dans un template</a></li></ul></li><li class="sidebar-sub-header"><a href="/symfony/30-user.html#gerer-les-droits-avec-les-voters" class="sidebar-link">Gérer les droits avec les Voters</a></li></ul></li><li><a href="/symfony/40-bundles.html" class="sidebar-link">Bundles</a></li><li><a href="/symfony/41-easy-admin.html" class="sidebar-link">Easy Admin Bundle</a></li><li><a href="/symfony/42-api-platform.html" class="sidebar-link">Api Platform</a></li><li><a href="/symfony/80-cheat-sheet.html" class="sidebar-link">Pense-bêtes</a></li><li><a href="/symfony/81-quotidien.html" class="sidebar-link">Symfony au quotidien</a></li><li><a href="/symfony/82-docker.html" class="sidebar-link">Travailler avec Docker</a></li><li><a href="/symfony/90-doggies.html" class="sidebar-link">Projet : annonces de SPA / éleveurs</a></li><li><a href="/symfony/91-vote.html" class="sidebar-link">Projet : vote citoyen</a></li><li><a href="/symfony/99-exercices.html" class="sidebar-link">Exercices</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js/" class="sidebar-heading clickable"><span>Javascript</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/lamp/" class="sidebar-link">Serveur Lamp</a></li><li><a href="/deploy/" class="sidebar-link">Déploiement</a></li><li><a href="/docker/" class="sidebar-link">Docker</a></li><li><a href="/ci/" class="sidebar-link">Intégration continue</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="connexion-et-securisation"><a href="#connexion-et-securisation" class="header-anchor">#</a> Connexion et sécurisation</h1> <p>La <a href="https://symfony.com/doc/current/security.html" target="_blank" rel="noopener noreferrer">documentation officielle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, que l'on va suivre / reprendre.</p> <p>⚠️ Cette partie a été écrite pour Symfony 5.3 et plusieurs choses ont été modifiées depuis la version 5.2 (le fonctionnement reste le même, mais plusieurs éléments étaient plus complexes). Vous trouverez une <a href="https://www.loom.com/embed/c35c8ab1e4614a4ebf0eeffd0f8fad94" target="_blank" rel="noopener noreferrer">version de présentation de la version 5.2 de Symfony dans cette vidéo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/2539a55e6a2e4d1a9e829b195268377c" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <h2 id="pour-resumer"><a href="#pour-resumer" class="header-anchor">#</a> Pour résumer</h2> <ul><li><code>php bin/console make:user</code> pour créer une classe servant à la connexion</li> <li><code>php bin/console make:auth</code> pour créer le système de connexion et mettre en place la sécurisation de base</li> <li>Mettre à jour l'Authenticator créé, ainsi que la page de connexion</li> <li>Pour s'assurer des droits d'un utilisateur, on peut utiliser :
<ul><li>L'annotation <code>@IsGranted()</code> (Controllers)</li> <li>La fonction <code>is_granted()</code> (Twig)</li> <li>La méthode <code>isGranted()</code> du service <code>Symfony\Component\Security\Core\Security</code> (services)</li></ul></li> <li>On peut récupérer l'utilisateur connecté avec :
<ul><li><code>$this-&gt;getUser()</code> dans un controller étendant <code>AbstractController</code></li> <li><code>$this-&gt;security-&gt;getUser()</code> dans un service où le service <code>Security</code> a été injecté</li> <li><code>app.user</code> dans une vue Twig</li></ul></li></ul> <h2 id="installation-et-preparation"><a href="#installation-et-preparation" class="header-anchor">#</a> Installation et préparation</h2> <p>Tout d'abord, installer le bundle nécessaire (il est inclus par défaut, sur les projets initialisés avec <code>--full</code>) :</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">composer</span> require symfony/security-bundle
</code></pre></div><p>Il faut alors créer une entité pour gérer nos utilisateurs (la plupart du temps, on l'appelle <code>User</code>, mais vous pouvez adapter le nom à votre besoin). On utilise la commande <code>make:user</code> pour générer cette entité particulière.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php bin/console make:user
</code></pre></div><p>Dans la plupart des cas, nous voulez stocker notre entité <code>User</code> en base (c'est pour cela que je parle d'entité 😉 ), mais sachez que ça n'est pas obligatoire.</p> <p>Il faut alors déterminer une propriété qui nous servira d'identifiant (une propriété dont la valeur sera unique et que nous afficherons à nos utilisateurs). En général, on crée une propriété <code>username</code> ou <code>email</code> pour cela.</p> <p>Et bien sûr, si nous stockons les informations en base, il faut demander à Symfony de hasher les mots de passe.</p> <p>La commande va nous ajouter / modifier plusieurs fichiers :</p> <ul><li><code>src/Entity/User.php</code> notre entité User</li> <li><code>src/Repository/UserRepository.php</code> le repository associé (noter la méthode <code>upgradePassword()</code>)</li> <li><code>config/packages/security.yaml</code> met à jour la configuration sur la sécurité, pour prendre en compte notre entité User</li></ul> <p>Si besoin d'ajouter plus de champs, on peut utiliser la commande <code>make:entity</code>. Il s'agit ensuite de créer une migration, de la vérifier et de la lancer.</p> <p>On obtient alors une entité <code>User</code> comme celle-ci (je n'ai pas ajouté de propriétés et ma propriété identifiant est <code>email</code>) :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Entity</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Repository<span class="token punctuation">\</span>UserRepository</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Doctrine<span class="token punctuation">\</span>ORM<span class="token punctuation">\</span>Mapping</span> <span class="token keyword">as</span> <span class="token constant">ORM</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>User<span class="token punctuation">\</span>PasswordAuthenticatedUserInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>User<span class="token punctuation">\</span>UserInterface</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ORM\Entity(repositoryClass=UserRepository::class)
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">UserInterface</span><span class="token punctuation">,</span> PasswordAuthenticatedUserInterface
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * @ORM\Id
     * @ORM\GeneratedValue
     * @ORM\Column(type=&quot;integer&quot;)
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$id</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @ORM\Column(type=&quot;string&quot;, length=180, unique=true)
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$email</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @ORM\Column(type=&quot;json&quot;)
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$roles</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @var string The hashed password
     * @ORM\Column(type=&quot;string&quot;)
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$password</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token keyword return-type">int</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">email</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setEmail</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$email</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">self</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">email</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * A visual identifier that represents this user.
     *
     * @see UserInterface
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUserIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">email</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @deprecated since Symfony 5.3, use getUserIdentifier instead
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">email</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see UserInterface
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$roles</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">roles</span><span class="token punctuation">;</span>
        <span class="token comment">// guarantee every user at least has ROLE_USER</span>
        <span class="token variable">$roles</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ROLE_USER'</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">array_unique</span><span class="token punctuation">(</span><span class="token variable">$roles</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setRoles</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$roles</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">self</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">roles</span> <span class="token operator">=</span> <span class="token variable">$roles</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see PasswordAuthenticatedUserInterface
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setPassword</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">self</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returning a salt is only needed, if you are not using a modern
     * hashing algorithm (e.g. bcrypt or sodium) in your security.yaml.
     *
     * @see UserInterface
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see UserInterface
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// If you store any temporary, sensitive data on the user, clear it here</span>
        <span class="token comment">// $this-&gt;plainPassword = null;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre></div><p>Je vous conseille ensuite des créer des fixtures (fausses données) pour entrer un ou plusieurs <code>User</code> dans votre base (utiliser la commande <code>make:fixtures</code> de <a href="https://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html" target="_blank" rel="noopener noreferrer">DoctrineFixturesBundle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>). Pour que les mots de passe soient encodés dans vos Fixtures, il faut bien penser à :</p> <ul><li>injecter le service <code>UserPasswordHasherInterface</code> et l'utiliser pour encoder le mot de passe.</li> <li>ou encoder vos mots de passe avec la commande <code>security:encode-password</code> de Symfony avant de les mettre dans vos <code>User</code></li></ul> <h2 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h2> <p>La configuration se fait dans le fichier <code>config/packages/security.yaml</code>. Détaillons-le (j'ai également ajouté des éléments utiles pour plus tard) :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token comment"># Pour activer certaines fonctionnalités (expérimentales) de Symfony </span>
    <span class="token key atrule">enable_authenticator_manager</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># https://symfony.com/doc/current/security.html#registering-the-user-hashing-passwords</span>
    <span class="token comment"># On définit ici les différents moyens de hasher </span>
    <span class="token comment"># nos mots de passe, en fonction des entités</span>
    <span class="token key atrule">password_hashers</span><span class="token punctuation">:</span>
        <span class="token key atrule">Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface</span><span class="token punctuation">:</span> <span class="token string">'auto'</span>
        <span class="token comment"># On dit au composant de Symfony de choisir </span>
        <span class="token comment"># l'algorithme (le plus efficace)</span>
        <span class="token comment"># pour encoder les mots de passe de l'entité User.</span>
        <span class="token comment"># On pourrait avoir plusieurs entités, avec des encodeurs différents</span>
        <span class="token key atrule">App\Entity\User</span><span class="token punctuation">:</span>
            <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> auto

    <span class="token comment"># On défini des providers (fournisseurs) pour dire quels entités </span>
    <span class="token comment"># nous servent à définir un utilisateur</span>
    <span class="token comment"># et quelle propriété nous permet de l'identifier</span>
    <span class="token comment"># https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers</span>
    <span class="token key atrule">providers</span><span class="token punctuation">:</span>
        <span class="token comment"># used to reload user from session &amp; other features (e.g. switch_user)</span>
        <span class="token key atrule">app_user_provider</span><span class="token punctuation">:</span>
            <span class="token key atrule">entity</span><span class="token punctuation">:</span>
                <span class="token key atrule">class</span><span class="token punctuation">:</span> App\Entity\User
                <span class="token key atrule">property</span><span class="token punctuation">:</span> email
                
    <span class="token comment"># Les firewalls vont nous permettre de définir différentes règles</span>
    <span class="token comment"># de sécurité (avec des manières de fonctionner différentes)</span>
    <span class="token comment"># Dans notre cas, le firewall main va être appliqué lors de l'appel </span>
    <span class="token comment"># de toutes nos routes et va vérifier si l'utilisateur</span>
    <span class="token comment"># peut ou non accéder à une page avec ses autorisations en cours</span>
    <span class="token comment"># (par exemple, s'il peut accéder à une page sans être connecté)</span>
    <span class="token key atrule">firewalls</span><span class="token punctuation">:</span>
        <span class="token key atrule">dev</span><span class="token punctuation">:</span>
            <span class="token key atrule">pattern</span><span class="token punctuation">:</span> ^/(_(profiler<span class="token punctuation">|</span>wdt)<span class="token punctuation">|</span>css<span class="token punctuation">|</span>images<span class="token punctuation">|</span>js)/
            <span class="token key atrule">security</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">main</span><span class="token punctuation">:</span>
            <span class="token key atrule">anonymous</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">lazy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> app_user_provider
            
            <span class="token comment"># On précise, au composant de sécurité, l'authenticator </span>
            <span class="token comment"># à utiliser pour gérer notre connexion</span>
            <span class="token key atrule">custom_authenticator</span><span class="token punctuation">:</span> App\Security\Authenticator
            <span class="token comment"># Plus de détails sur la fonctionnalité &quot;se souvenir de moi&quot; ici : </span>
            <span class="token comment"># https://symfony.com/doc/current/security/remember_me.html</span>
            <span class="token key atrule">remember_me</span><span class="token punctuation">:</span>
                <span class="token key atrule">secret</span><span class="token punctuation">:</span>   <span class="token string">'%kernel.secret%'</span>
                <span class="token key atrule">lifetime</span><span class="token punctuation">:</span> <span class="token number">604800</span> <span class="token comment"># 1 semaine, en secondes</span>
                <span class="token key atrule">path</span><span class="token punctuation">:</span>     /
                <span class="token comment"># Par défaut, cette fonctionnalité n'est activé que si l'utilisateur coche une case</span>
                <span class="token comment"># Vous pouvez faire en sorte que tout utilisateur connecté le reste 1 semaine</span>
                <span class="token comment"># en dé-commentant la ligne ci-dessous</span>
                <span class="token comment">#always_remember_me: true</span>
            
            <span class="token comment"># Le nom de la route gérant la déconnexion</span>
            <span class="token comment"># Symfony se charge de déterminer s'il s'agit du nom d'une route ou d'un chemin</span>
            <span class="token comment"># (j'aurais pu mettre /deconnexion, par exemple)</span>
            <span class="token key atrule">logout</span><span class="token punctuation">:</span>
                <span class="token key atrule">path</span><span class="token punctuation">:</span> app_logout
                <span class="token comment"># Vous pouvez également choisir une route où envoyer votre utilisateur après déconnexion</span>
                <span class="token comment"># target: app_any_route</span>

            <span class="token comment"># activate different ways to authenticate</span>
            <span class="token comment"># https://symfony.com/doc/current/security.html#firewalls-authentication</span>

            <span class="token comment"># https://symfony.com/doc/current/security/impersonating_user.html</span>
            <span class="token comment"># switch_user: true</span>

    <span class="token comment"># Ici, on donne des règles pour demander des rôles précis aux utilisateurs</span>
    <span class="token comment"># selon une expression régulière sur les chemins demandés.</span>
    <span class="token comment"># L'intérêt est de demander des droits précis pour accéder à des zones du site</span>
    <span class="token comment"># (toute la partie admin, ou la gestion du compte, par exemple)</span>
    <span class="token comment"># Si l'utilisateur n'a pas les bons droits, nous pouvons l'envoyer</span>
    <span class="token comment"># vers le formulaire de connexion, par exemple</span>
    <span class="token key atrule">access_control</span><span class="token punctuation">:</span>
        <span class="token comment"># On demande à l'utilisateur d'avoir le rôle ROLE_ADMIN, </span>
        <span class="token comment"># pour toutes les routes commençant par /admin</span>
        <span class="token comment"># - { path: ^/admin, roles: ROLE_ADMIN } </span>
        <span class="token comment"># On demande à l'utilisateur d'avoir le rôle ROLE_USER, </span>
        <span class="token comment"># pour toutes les routes commençant par /profile</span>
        <span class="token comment"># - { path: ^/profile, roles: ROLE_USER }</span>
</code></pre></div><p>Ce fichier est le cœur de la sécurisation de votre site, mais beaucoup d'autres éléments peuvent venir le compléter et le raffiner.</p> <h2 id="connecter-un-utilisateur"><a href="#connecter-un-utilisateur" class="header-anchor">#</a> Connecter un utilisateur</h2> <p><a href="https://symfony.com/doc/current/security/auth_providers.html" target="_blank" rel="noopener noreferrer">Les différents Authentication Providers fournis par Symfony<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Des bundles comme le <a href="https://github.com/hwi/HWIOAuthBundle" target="_blank" rel="noopener noreferrer">HWIOAuthBundle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> complètent encore cette liste.</p> <p>L'un des moyens les plus classiques, le formulaire de connexion, est le cas que nous allons voir. Si vous voulez apprendre en détail comment créer un système de connexion, je vous recommande chaudement <a href="https://symfony.com/doc/current/security/guard_authentication.html" target="_blank" rel="noopener noreferrer">la documentation de Symfony sur la création d'une authentification par token d'API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Pour créer notre système de connexion, nous allons utiliser la commande <code>make:auth</code> qui va nous préparer le travail.</p> <p><code>php bin/console make:auth</code></p> <div class="language- extra-class"><pre class="language-text"><code>What style of authentication do you want? [Empty authenticator]:
 [0] Empty authenticator
 [1] Login form authenticator
</code></pre></div><p>Ici, on fait le choix 1.</p> <div class="language- extra-class"><pre class="language-text"><code>The class name of the authenticator to create (e.g. AppCustomAuthenticator):
</code></pre></div><p>Si on suit la documentation, on va entrer <code>LoginFormAuthenticator</code>, mais vous pouvez le nommer comme bon vous semble.</p> <div class="language- extra-class"><pre class="language-text"><code>Choose a name for the controller class (e.g. SecurityController) [SecurityController]:
</code></pre></div><p>Le nom de <code>SecurityController</code> est le plus courant, et vous le verrez dans beaucoup de projets Symfony.</p> <div class="language- extra-class"><pre class="language-text"><code>Do you want to generate a '/logout' URL? (yes/no) [yes]:
</code></pre></div><p>Je vous conseille de toujours créer un moyen pour vos utilisateurs de se déconnecter. Ils apprécieront 😉 .</p> <p>On obtient alors plusieurs fichiers, dont le <code>SecurityController</code> suivant :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// src/Controller/SecurityController.php</span>
<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkBundle<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>AbstractController</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Routing<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authentication<span class="token punctuation">\</span>AuthenticationUtils</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">SecurityController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractController</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * @Route(&quot;/login&quot;, name=&quot;app_login&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token class-name type-declaration">AuthenticationUtils</span> <span class="token variable">$authenticationUtils</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Response</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// if ($this-&gt;getUser()) {</span>
        <span class="token comment">//     return $this-&gt;redirectToRoute('target_path');</span>
        <span class="token comment">// }</span>

        <span class="token comment">// get the login error if there is one</span>
        <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token variable">$authenticationUtils</span><span class="token operator">-&gt;</span><span class="token function">getLastAuthenticationError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// last username entered by the user</span>
        <span class="token variable">$lastUsername</span> <span class="token operator">=</span> <span class="token variable">$authenticationUtils</span><span class="token operator">-&gt;</span><span class="token function">getLastUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'security/login.html.twig'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'last_username'</span> <span class="token operator">=&gt;</span> <span class="token variable">$lastUsername</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'error'</span> <span class="token operator">=&gt;</span> <span class="token variable">$error</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @Route(&quot;/logout&quot;, name=&quot;app_logout&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>LogicException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'This method can be blank - it will be intercepted by the logout key on your firewall.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Je vous conseille de personnaliser les chemins et les noms des routes, pour correspondre à <em>vos</em> conventions de nommage. Par exemple, je mettrais les chemins en français et renommerais les routes <code>security_login</code>et<code>security_logout</code>. Il faudra bien sûr modifier ces noms à plusieurs endroits (<code>login.html.twig</code> et <code>security.yaml</code>, notamment).</p> <p>Notez que le fichier <code>login.html.twig</code> contient un formulaire html et non un formulaire Symfony. C'est ici voulu et rien ne vous empêche d'en créer un, si ce n'est de faire extrêmement attention aux noms des champs. Il contient également une section à dé-commenter si vous souhaitez activer la fonctionnalité &quot;Se souvenir de moi&quot;.</p> <p>Il nous reste maintenant à décortiquer / expliquer le <code>LoginFormAuthenticator</code> qui a été généré :</p> <div class="language-php extra-class"><pre class="language-php"><code>// src/Security/LoginFormAuthenticator.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Security</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>RedirectResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Routing<span class="token punctuation">\</span>Generator<span class="token punctuation">\</span>UrlGeneratorInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Authentication<span class="token punctuation">\</span>Token<span class="token punctuation">\</span>TokenInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Security</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>AbstractLoginFormAuthenticator</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>Passport<span class="token punctuation">\</span>Badge<span class="token punctuation">\</span>CsrfTokenBadge</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>Passport<span class="token punctuation">\</span>Badge<span class="token punctuation">\</span>UserBadge</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>Passport<span class="token punctuation">\</span>Credentials<span class="token punctuation">\</span>PasswordCredentials</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>Passport<span class="token punctuation">\</span>Passport</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Authenticator<span class="token punctuation">\</span>Passport<span class="token punctuation">\</span>PassportInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Util<span class="token punctuation">\</span>TargetPathTrait</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Authenticator</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoginFormAuthenticator</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">TargetPathTrait</span><span class="token punctuation">;</span>

    <span class="token comment">// La route de login par défaut. À adapter à vos besoins (ici, je remplace par security_login, personnellement)</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">LOGIN_ROUTE</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'app_login'</span><span class="token punctuation">;</span>

    <span class="token comment">// Service de génération d'URL / de chemins</span>
    <span class="token keyword">private</span> <span class="token class-name type-declaration">UrlGeneratorInterface</span> <span class="token variable">$urlGenerator</span><span class="token punctuation">;</span>

    <span class="token comment">// On pourrait injecter ici d'autres services qui nous seraient utiles lors de la connexion (un service qui vérifierait si nous nous connectons depuis une nouvelle IP, par exemple)</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">UrlGeneratorInterface</span> <span class="token variable">$urlGenerator</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">urlGenerator</span> <span class="token operator">=</span> <span class="token variable">$urlGenerator</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">authenticate</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">PassportInterface</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// On récupère les données envoyées via POST</span>
        <span class="token comment">// Si vous modifiez les noms des champs de votre formulaire,</span>
        <span class="token comment">// c'est dans cette méthode qu'il faudra faire les modifications nécessaires</span>
        <span class="token variable">$email</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name static-context">Security</span><span class="token operator">::</span><span class="token constant">LAST_USERNAME</span><span class="token punctuation">,</span> <span class="token variable">$email</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Passport</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">UserBadge</span><span class="token punctuation">(</span><span class="token variable">$email</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">PasswordCredentials</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token keyword">new</span> <span class="token class-name">CsrfTokenBadge</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'authenticate'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'_csrf_token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// Cette méthode permet de définir le comportement</span>
    <span class="token comment">// après une connexion réussie.</span>
    <span class="token comment">// Par défaut, on redirige l'utilisateur vers la page demandée au départ</span>
    <span class="token comment">// ou une page définie par défaut (souvent, la page d'accueil</span>
    <span class="token comment">// ou du compte)</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">TokenInterface</span> <span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$firewallName</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name return-type">Response</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Par défaut, un utilisateur est renvoyé vers la page où il souhaitait aller.</span>
        <span class="token comment">// Par exemple, s'il avait demandé la page /admin, sans être connecté, la page de connexion apparait. Une fois ses identifiants entrés et vérifiés, il sera renvoyé vers cette page /admin, automatiquement</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$targetPath</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getTargetPath</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$firewallName</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedirectResponse</span><span class="token punctuation">(</span><span class="token variable">$targetPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// For example:</span>
        <span class="token comment">//return new RedirectResponse($this-&gt;urlGenerator-&gt;generate('some_route'));</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'TODO: provide a valid redirect inside '</span><span class="token operator">.</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Pour récupérer l'url (le chemin) de la route de login</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getLoginUrl</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">urlGenerator</span><span class="token operator">-&gt;</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">LOGIN_ROUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><p>⚠️ Ne pas oublier de compléter la méthode <code>onAuthenticationSuccess</code> de notre authenticator et lui donner une url pour rediriger l'utilisateur.</p> <h2 id="utiliser-les-droits"><a href="#utiliser-les-droits" class="header-anchor">#</a> Utiliser les droits</h2> <p>Nos <code>User</code> ont toujours au moins le <code>ROLE_USER</code> (voir leur méthode <code>getRoles()</code>), donc un utilisateur connecté a au moins ce rôle. Voir également la section <code>role_hierarchy</code>dans le <code>security.yaml</code> de ce chapitre.</p> <h3 id="security-yaml"><a href="#security-yaml" class="header-anchor">#</a> Security.yaml</h3> <p>Avec Symfony, il y a de nombreux moyens de vérifier si un utilisateur peut réaliser une action. Le premier, dans le fichier <code>security.yaml</code>, permet de définir une sécurisation pour des plages d'urls :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token key atrule">access_control</span><span class="token punctuation">:</span>
        <span class="token comment"># On demande à l'utilisateur d'avoir le rôle ROLE_ADMIN, </span>
        <span class="token comment"># pour toutes les routes commençant par /admin</span>
        <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> ^/admin<span class="token punctuation">,</span> <span class="token key atrule">roles</span><span class="token punctuation">:</span> ROLE_ADMIN <span class="token punctuation">}</span> 
</code></pre></div><p>Cet exemple basique contient l'essentiel, mais vous pouvez <a href="https://symfony.com/doc/current/security/access_control.html" target="_blank" rel="noopener noreferrer">aller beaucoup plus loin dans la précision<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="isgranted-et-is-granted"><a href="#isgranted-et-is-granted" class="header-anchor">#</a> IsGranted() et is_granted()</h3> <p>Dans un contrôleur :</p> <div class="language-php extra-class"><pre class="language-php"><code>    <span class="token comment">// src/Controller/AdminController.php</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>IsGranted</span><span class="token punctuation">;</span>
   
    <span class="token comment">/**
     * Pour accéder à TOUTES les méthodes de ce contrôleur, il faut avoir le ROLE_ADMIN
     *
     * @IsGranted(&quot;ROLE_ADMIN&quot;)
     */</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">AdminController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractController</span>
    <span class="token punctuation">{</span>
       <span class="token comment">/**
        * Il faut avoir le rôle ROLE_ADMIN pour cette méthode seulement
        *
        * @IsGranted(&quot;ROLE_ADMIN&quot;)
        */</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">adminDashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Response</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Fait exactement la même chose que l'annotation au-dessus.</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">denyAccessUnlessGranted</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Dans un template :</p> <div class="language-twig extra-class"><pre class="language-twig"><code><span class="token tag"><span class="token ld"><span class="token punctuation">{%</span> <span class="token keyword">if</span></span> <span class="token property">is_granted</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">'</span>ROLE_ADMIN<span class="token punctuation">'</span></span><span class="token punctuation">)</span> <span class="token rd"><span class="token punctuation">%}</span></span></span>
    <span class="token comment">{# Seuls les admins peuvent voir ceci #}</span>
<span class="token tag"><span class="token ld"><span class="token punctuation">{%</span> <span class="token keyword">endif</span></span> <span class="token rd"><span class="token punctuation">%}</span></span></span>
</code></pre></div><p>Vous pouvez également utiliser cette fonctionnalité dans un service, en injectant le service <code>Symfony\Component\Security\Core\Security</code> :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// src/Newsletter/NewsletterManager.php</span>

<span class="token comment">// ...</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>AccessDeniedException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Security</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">SalesReportManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$security</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Security</span> <span class="token variable">$security</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">security</span> <span class="token operator">=</span> <span class="token variable">$security</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNewsletter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$salesData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">security</span><span class="token operator">-&gt;</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ROLE_SALES_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$salesData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'top_secret_numbers'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="recuperer-le-user-connecte"><a href="#recuperer-le-user-connecte" class="header-anchor">#</a> Récupérer le <code>User</code> connecté</h2> <h3 id="dans-un-controleur"><a href="#dans-un-controleur" class="header-anchor">#</a> Dans un contrôleur</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Response</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Renvoie votre utilisateur (ou null s'il n'est pas connecté)</span>
    <span class="token comment">// Il est conseillé d'ajouter un commentaire pour que l'IDE connaisse</span>
    <span class="token comment">// la classe exacte utilisée (par défaut, il voir un objet UserInterface, sans vos méthodes)</span>

    <span class="token comment">/** @var User $user */</span>    
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dans-un-service"><a href="#dans-un-service" class="header-anchor">#</a> Dans un service</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// src/Service/ExampleService.php</span>
<span class="token comment">// ...</span>

<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Security<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Security</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ExampleService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$security</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Security</span> <span class="token variable">$security</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Il vaut mieux éviter d'appeler le User directement</span>
        <span class="token comment">// dans le constructeur d'un service</span>
        <span class="token comment">// Il pourrait ne pas être correctement initialisé à ce moment-là</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">security</span> <span class="token operator">=</span> <span class="token variable">$security</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Retourne le User (ou null si pas connecté)</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">security</span><span class="token operator">-&gt;</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dans-un-template"><a href="#dans-un-template" class="header-anchor">#</a> Dans un template</h3> <p><code>app.user</code> Retourne le User (ou null si pas connecté)</p> <h2 id="gerer-les-droits-avec-les-voters"><a href="#gerer-les-droits-avec-les-voters" class="header-anchor">#</a> Gérer les droits avec les Voters</h2> <p>Une fonctionnalité très avancée, les Voters, vous permet de gérer les droits aussi finement que vous le souhaitez. Bien que les rôles permettent déjà beaucoup de puissance, il arrive que des droits plus précis soient nécessaires. Par exemple, si vous créez un site pour une grosse entreprise, avec un service marketing et un autre commercial, il se peut que chaque service (et chaque utilisateur de ces services) aient accès seulement à des fonctionnalités précises.</p> <p>Pour ces cas, bien plus complexes, de gestion des ACL (Access Control Lists), je vous recommande très fortement <a href="https://symfony.com/doc/current/security/voters.html" target="_blank" rel="noopener noreferrer">la documentation Symfony sur les voters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et vous pouvez aller encore plus loin, avec <a href="https://symfony.com/doc/current/components/security/authorization.html" target="_blank" rel="noopener noreferrer">la documentation sur le processus d'autorisation de Symfony<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/symfony/27-event-listeners.html" class="prev">
        Event listeners/subscribers
      </a></span> <span class="next"><a href="/symfony/40-bundles.html">
        Bundles
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a0283a3d.js" defer></script><script src="/assets/js/2.2bb1f65b.js" defer></script><script src="/assets/js/52.dde625a3.js" defer></script>
  </body>
</html>
