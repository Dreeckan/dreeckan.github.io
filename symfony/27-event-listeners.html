<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event listeners/subscribers</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Les formations de Rémi Jarjat pour Human Booster">
    
    <link rel="preload" href="/assets/css/0.styles.f78ef515.css" as="style"><link rel="preload" href="/assets/js/app.a0283a3d.js" as="script"><link rel="preload" href="/assets/js/2.2bb1f65b.js" as="script"><link rel="preload" href="/assets/js/51.43768ca2.js" as="script"><link rel="prefetch" href="/assets/js/10.a27b6e9d.js"><link rel="prefetch" href="/assets/js/11.2193e9e3.js"><link rel="prefetch" href="/assets/js/12.f39a5b44.js"><link rel="prefetch" href="/assets/js/13.2d6a44aa.js"><link rel="prefetch" href="/assets/js/14.0673e9ad.js"><link rel="prefetch" href="/assets/js/15.a5eeeada.js"><link rel="prefetch" href="/assets/js/16.33dfc880.js"><link rel="prefetch" href="/assets/js/17.c79025e1.js"><link rel="prefetch" href="/assets/js/18.959ecd03.js"><link rel="prefetch" href="/assets/js/19.9b33ed18.js"><link rel="prefetch" href="/assets/js/20.ef228a5b.js"><link rel="prefetch" href="/assets/js/21.95b935c1.js"><link rel="prefetch" href="/assets/js/22.6089ec44.js"><link rel="prefetch" href="/assets/js/23.1786dcbd.js"><link rel="prefetch" href="/assets/js/24.1cc8c701.js"><link rel="prefetch" href="/assets/js/25.bfc350ad.js"><link rel="prefetch" href="/assets/js/26.bc869606.js"><link rel="prefetch" href="/assets/js/27.2974731f.js"><link rel="prefetch" href="/assets/js/28.c59ffda1.js"><link rel="prefetch" href="/assets/js/29.a4f4f78c.js"><link rel="prefetch" href="/assets/js/3.b306ebdc.js"><link rel="prefetch" href="/assets/js/30.f86e1c24.js"><link rel="prefetch" href="/assets/js/31.3a368f51.js"><link rel="prefetch" href="/assets/js/32.ae32716d.js"><link rel="prefetch" href="/assets/js/33.04577fe2.js"><link rel="prefetch" href="/assets/js/34.0036621d.js"><link rel="prefetch" href="/assets/js/35.ae9cca52.js"><link rel="prefetch" href="/assets/js/36.46328e65.js"><link rel="prefetch" href="/assets/js/37.b265ca29.js"><link rel="prefetch" href="/assets/js/38.30e09b09.js"><link rel="prefetch" href="/assets/js/39.b34ea9f8.js"><link rel="prefetch" href="/assets/js/4.1b3f0ff6.js"><link rel="prefetch" href="/assets/js/40.6ee002ae.js"><link rel="prefetch" href="/assets/js/41.fc420cf4.js"><link rel="prefetch" href="/assets/js/42.209ec249.js"><link rel="prefetch" href="/assets/js/43.2d7d1cd7.js"><link rel="prefetch" href="/assets/js/44.b9fd8430.js"><link rel="prefetch" href="/assets/js/45.15ab68bd.js"><link rel="prefetch" href="/assets/js/46.01b8ec0e.js"><link rel="prefetch" href="/assets/js/47.112cd2f4.js"><link rel="prefetch" href="/assets/js/48.867e58b9.js"><link rel="prefetch" href="/assets/js/49.3ac37d3e.js"><link rel="prefetch" href="/assets/js/5.784f0707.js"><link rel="prefetch" href="/assets/js/50.f9dae8e2.js"><link rel="prefetch" href="/assets/js/52.dde625a3.js"><link rel="prefetch" href="/assets/js/53.72d8e143.js"><link rel="prefetch" href="/assets/js/54.bc802a1c.js"><link rel="prefetch" href="/assets/js/55.e1f55ab2.js"><link rel="prefetch" href="/assets/js/56.1118b442.js"><link rel="prefetch" href="/assets/js/57.c6e74a85.js"><link rel="prefetch" href="/assets/js/58.cfab71d0.js"><link rel="prefetch" href="/assets/js/59.6fb84388.js"><link rel="prefetch" href="/assets/js/6.a94e70e9.js"><link rel="prefetch" href="/assets/js/60.f130f013.js"><link rel="prefetch" href="/assets/js/61.99515c03.js"><link rel="prefetch" href="/assets/js/62.d3e48f49.js"><link rel="prefetch" href="/assets/js/7.8a7612b0.js"><link rel="prefetch" href="/assets/js/8.82725242.js"><link rel="prefetch" href="/assets/js/9.8e900de4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f78ef515.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/LogoHB.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Liste des cours</a></li><li><a href="/general/" class="sidebar-link">Culture numérique</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/git/" class="sidebar-heading clickable"><span>Git</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/linux/" class="sidebar-link">Linux</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/php/" class="sidebar-heading clickable"><span>PHP</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/symfony/" class="sidebar-heading clickable router-link-active open"><span>Symfony</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/symfony/01-installation.html" class="sidebar-link">Installer Symfony et son environnement de travail</a></li><li><a href="/symfony/10-structure.html" class="sidebar-link">Structure et utilisation d'un projet</a></li><li><a href="/symfony/20-routing.html" class="sidebar-link">Le routing</a></li><li><a href="/symfony/21-controllers.html" class="sidebar-link">Les controllers</a></li><li><a href="/symfony/22-twig.html" class="sidebar-link">Twig</a></li><li><a href="/symfony/23-injection.html" class="sidebar-link">Les services et l'injection de dépendances</a></li><li><a href="/symfony/24-doctrine.html" class="sidebar-link">Doctrine et la BdD</a></li><li><a href="/symfony/25-formulaires.html" class="sidebar-link">Formulaires</a></li><li><a href="/symfony/26-translation.html" class="sidebar-link">Les traductions</a></li><li><a href="/symfony/27-event-listeners.html" aria-current="page" class="active sidebar-link">Event listeners/subscribers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#pour-resumer" class="sidebar-link">Pour résumer</a></li><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#listener-ou-subscriber" class="sidebar-link">Listener ou subscriber ?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#que-choisir" class="sidebar-link">Que choisir ?</a></li></ul></li><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#creer-un-subscriber" class="sidebar-link">Créer un subscriber</a></li><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#creer-nos-propres-evenements" class="sidebar-link">Créer nos propres événements</a></li><li class="sidebar-sub-header"><a href="/symfony/27-event-listeners.html#declencher-un-evenement-manuellement" class="sidebar-link">Déclencher un événement manuellement</a></li></ul></li><li><a href="/symfony/30-user.html" class="sidebar-link">Connexion et sécurisation</a></li><li><a href="/symfony/40-bundles.html" class="sidebar-link">Bundles</a></li><li><a href="/symfony/41-easy-admin.html" class="sidebar-link">Easy Admin Bundle</a></li><li><a href="/symfony/42-api-platform.html" class="sidebar-link">Api Platform</a></li><li><a href="/symfony/80-cheat-sheet.html" class="sidebar-link">Pense-bêtes</a></li><li><a href="/symfony/81-quotidien.html" class="sidebar-link">Symfony au quotidien</a></li><li><a href="/symfony/82-docker.html" class="sidebar-link">Travailler avec Docker</a></li><li><a href="/symfony/90-doggies.html" class="sidebar-link">Projet : annonces de SPA / éleveurs</a></li><li><a href="/symfony/91-vote.html" class="sidebar-link">Projet : vote citoyen</a></li><li><a href="/symfony/99-exercices.html" class="sidebar-link">Exercices</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js/" class="sidebar-heading clickable"><span>Javascript</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/lamp/" class="sidebar-link">Serveur Lamp</a></li><li><a href="/deploy/" class="sidebar-link">Déploiement</a></li><li><a href="/docker/" class="sidebar-link">Docker</a></li><li><a href="/ci/" class="sidebar-link">Intégration continue</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="event-listeners-subscribers"><a href="#event-listeners-subscribers" class="header-anchor">#</a> Event listeners/subscribers</h1> <p>En vidéo :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/01b83b1084b8486590cc03c05deb8392" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <p>Les event listeners (ou écouteurs d'événement) et les event subscribers (souscripteurs d'événement) sont des services qui vont être appelés lorsqu'un ou des événements précis sont déclenchés. Ils viennent compléter un fonctionnement existant.</p> <h2 id="pour-resumer"><a href="#pour-resumer" class="header-anchor">#</a> Pour résumer</h2> <ul><li>Les Event Listeners et Event Subscribers sont des services (classes Php) et ont un comportement très similaire.</li> <li>Les Event Listeners :
<ul><li>permettent d'écouter un événement (Event), défini par son nom (unique)</li> <li>ont une méthode par Event écouté, de la forme <code>on</code> + nom de l'Event en CamelCase (<code>onKernelException</code> pour un événement <code>kernel.exception</code>)</li> <li>cette méthode prend en paramètre un objet Event, lié à l'événement écouté</li> <li>doit être déclaré avec un tag par event dans le fichier <code>config/services.yaml</code>.</li></ul></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">App\EventListener\ExceptionListener</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kernel.event_listener<span class="token punctuation">,</span> <span class="token key atrule">event</span><span class="token punctuation">:</span> kernel.exception <span class="token punctuation">}</span>
</code></pre></div><ul><li>Les Event Subscribers
<ul><li>implémentent l'interface <code>Symfony\Component\EventDispatcher\EventSubscriberInterface</code></li> <li>permettent d'écouter un ou plusieurs événements (Event)</li> <li>la méthode <code>getSubscribedEvents()</code> permet de faire le lien entre les événements écoutés (on peut écrire le FQCN de l'événement ou le nom de l'événement) et les méthodes à appeler pour chacun (avec d'éventuelles priorités)</li> <li>les méthodes ont des noms libres, mais les paramètres sont définis par l'événement.</li></ul></li> <li>Il est possible de créer nos propres événements en étendant <code>Symfony\Contracts\EventDispatcher\Event</code>.</li> <li>Ces événements doivent toujours avoir un nom <strong>unique</strong>.</li> <li>On peut émettre un événement grâce au service <code>event_dispatcher</code> (depuis un controller) ou depuis le service <code>Symfony\Contracts\EventDispatcher\EventDispatcherInterface</code>.</li></ul> <h2 id="listener-ou-subscriber"><a href="#listener-ou-subscriber" class="header-anchor">#</a> Listener ou subscriber ?</h2> <p>Un listener est une classe liée à un ou plusieurs événements, mais qui n'a pas conscience des événements écoutés (ils ne sont pas indiqués dans la classe).
Un subscriber est une classe liée à un ou plusieurs événements et il est toujours aisé de savoir quel événement est appelé (ils sont indiqués dans la classe).</p> <p>Une autre différence majeure est la mise en place : le listener oblige à créer une entrée dans <code>config/services.yaml</code>, alors que le subscriber n'en a pas besoin.</p> <p>Prenons un listener <code>src/EventListener/ExceptionListener.php</code> surveillant si une exception a été envoyée :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>EventListener</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>ExceptionEvent</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ExceptionListener</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">onKernelException</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ExceptionEvent</span> <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ... Code à déclencher en cas d'exception</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Il faudra l'enregistrer dans <code>config/services.yaml</code> :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">App\EventListener\ExceptionListener</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kernel.event_listener<span class="token punctuation">,</span> <span class="token key atrule">event</span><span class="token punctuation">:</span> kernel.exception <span class="token punctuation">}</span>
</code></pre></div><p>⚠️ ce sont les tags qui sont importants ici. Vous pouvez injecter automatiquement d'autres services dans celui-ci, malgré tout.</p> <p>Un subscriber sera plutôt de cette forme :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>EventSubscriber</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>EventDispatcher<span class="token punctuation">\</span>EventSubscriberInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>ExceptionEvent</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>KernelEvents</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ExceptionSubscriber</span> <span class="token keyword">implements</span> <span class="token class-name">EventSubscriberInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getSubscribedEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// retourne les événements souscrits, les méthodes associées et leurs priorités</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token comment">// On souscrit à l'événement KernelEvents::EXCEPTION</span>
            <span class="token class-name static-context">KernelEvents</span><span class="token operator">::</span><span class="token constant">EXCEPTION</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
                <span class="token comment">// Les 3 méthodes ci-dessous seront appelées,</span>
                <span class="token comment">// le nombre (optionnel) permet de savoir l'ordre d'appel.</span>
                <span class="token comment">// Les méthodes associées au nombre le plus haut seront exécutées en premier,</span>
                <span class="token comment">// puis celles avec un nombre plus bas, etc.</span>
                <span class="token punctuation">[</span><span class="token string single-quoted-string">'processException'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string single-quoted-string">'logException'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string single-quoted-string">'notifyException'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">processException</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ExceptionEvent</span> <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">logException</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ExceptionEvent</span> <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">notifyException</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ExceptionEvent</span> <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>⚠️ C'est la méthode <code>getSubscribedEvents</code> qui définit quelle méthode est appelée pour quel événement et dans quel ordre. Il est donc très important de bien la comprendre.</p> <h3 id="que-choisir"><a href="#que-choisir" class="header-anchor">#</a> Que choisir ?</h3> <p>Personnellement, j'ai toujours utilisé des subscribers (autant que possible), le fonctionnement des deux types étant très proches. Ma préférence vient du fait que je préfère avoir toutes les informations dans une classe, plutôt que de devoir chercher sa configuration et le contenu de la classe pour comprendre le fonctionnement.</p> <p>Il semble que les listeners soient plus souples et permettent aux bundles de plus facilement (dés)activer des listeners en fonction de la configuration. Il s'agit en grande partie d'un choix personnel, donc 😉 .</p> <h2 id="creer-un-subscriber"><a href="#creer-un-subscriber" class="header-anchor">#</a> Créer un subscriber</h2> <p><a href="https://symfony.com/doc/current/doctrine/events.html" target="_blank" rel="noopener noreferrer">Les event listeners de Doctrine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sont un cas un peu particulier, et nous allons commencer par eux.</p> <p>Nous allons créer un event subscriber qui hash un mot de passe (<a href="/symfony/30-user.html">voir partie suivante, sur le système de connexion</a>) lorsqu'on enregistre un objet <code>User</code>. Nous en ferons ensuite un autre faisant la même opération, mais lors de l'enregistrement dans EasyAdmin. Les deux sont, bien sûr, redondant et sont présentés pour vous montrer les deux cas de figure.</p> <p>Créons un fichier <code>src/EventListener/HashPasswordSubscriber.php</code> :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>EventListener</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Entity<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Doctrine<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>DoctrineBundle<span class="token punctuation">\</span>EventSubscriber<span class="token punctuation">\</span>EventSubscriberInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Doctrine<span class="token punctuation">\</span>ORM<span class="token punctuation">\</span>Events</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Doctrine<span class="token punctuation">\</span>Persistence<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>LifecycleEventArgs</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>PasswordHasher<span class="token punctuation">\</span>Hasher<span class="token punctuation">\</span>UserPasswordHasherInterface</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">HashPasswordSubscriber</span> <span class="token keyword">implements</span> <span class="token class-name">EventSubscriberInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name type-declaration">UserPasswordHasherInterface</span> <span class="token variable">$hasher</span><span class="token punctuation">;</span>
    
    <span class="token comment">// On injecte le service de hashage de mot de passe</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">UserPasswordHasherInterface</span> <span class="token variable">$hasher</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hasher</span> <span class="token operator">=</span> <span class="token variable">$hasher</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Les event subscribers de Doctrine ont des méthodes figées</span>
    <span class="token comment">// et getSubscribedEvents() ne renvoie que les événements écoutés</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getSubscribedEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token class-name static-context">Events</span><span class="token operator">::</span><span class="token constant">prePersist</span><span class="token punctuation">,</span>
            <span class="token class-name static-context">Events</span><span class="token operator">::</span><span class="token constant">preUpdate</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Cette méthode est automatiquement appelée lorsque l'événement Events::prePersist est déclenché</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">prePersist</span><span class="token punctuation">(</span><span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hashPassword</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Cette méthode est automatiquement appelée lorsque l'événement Events::preUpdate est déclenché</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">preUpdate</span><span class="token punctuation">(</span><span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hashPassword</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">hashPassword</span><span class="token punctuation">(</span><span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// On récupère l'entité qui a déclenché l'événement</span>
        <span class="token variable">$entity</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token operator">-&gt;</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Si ça n'est pas un User ou si la propriété plainPassword est vide,</span>
        <span class="token comment">// On ne fait rien</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$entity</span> <span class="token keyword">instanceof</span> <span class="token class-name">User</span> <span class="token operator">||</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">getPlainPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// On définit le nouveau mot de passe, en hashant la propriété plainPassword (temporaire)</span>
        <span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">setPassword</span><span class="token punctuation">(</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">passwordHasher</span><span class="token operator">-&gt;</span><span class="token function">hashPassword</span><span class="token punctuation">(</span><span class="token variable">$entity</span><span class="token punctuation">,</span> <span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">getPlainPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>La même chose, mais en se basant sur les événements de EasyAdmin (et donc uniquement dans ce contexte) :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>EventListener</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Entity<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">EasyCorp<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>EasyAdminBundle<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>BeforeEntityPersistedEvent</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">EasyCorp<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>EasyAdminBundle<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>BeforeEntityUpdatedEvent</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>EventDispatcher<span class="token punctuation">\</span>EventSubscriberInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>PasswordHasher<span class="token punctuation">\</span>Hasher<span class="token punctuation">\</span>UserPasswordHasherInterface</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">AdminUserUpdateSubscriber</span> <span class="token keyword">implements</span> <span class="token class-name">EventSubscriberInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name type-declaration">UserPasswordHasherInterface</span> <span class="token variable">$hasher</span><span class="token punctuation">;</span>

    <span class="token comment">// On injecte le service de hashage de mot de passe</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">UserPasswordHasherInterface</span> <span class="token variable">$hasher</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hasher</span> <span class="token operator">=</span> <span class="token variable">$hasher</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// On définit quelle méthode appeler lors du déclenchement d'un des événements</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getSubscribedEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Notez qu'aucune priorité n'est définie (c'est le cas le plus courant, pour moi).</span>
        <span class="token comment">// Ceci est équivalent à une priorité de 0</span>
        <span class="token comment">// Notez également que l'on utilise le FQCN des événement, et non une constante. Les deux fonctionnent ;)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token class-name static-context">BeforeEntityPersistedEvent</span><span class="token operator">::</span><span class="token keyword">class</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'updateUserPassword'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token class-name static-context">BeforeEntityUpdatedEvent</span><span class="token operator">::</span><span class="token keyword">class</span>   <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'updateUserPassword'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param BeforeEntityPersistedEvent|BeforeEntityUpdatedEvent $event
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">updateUserPassword</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$entity</span> <span class="token operator">=</span> <span class="token variable">$event</span><span class="token operator">-&gt;</span><span class="token function">getEntityInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$entity</span> <span class="token keyword">instanceof</span> <span class="token class-name">User</span> <span class="token operator">||</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">getPlainPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// On définit le nouveau mot de passe, en hashant la propriété plainPassword (temporaire)</span>
        <span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">setPassword</span><span class="token punctuation">(</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hasher</span><span class="token operator">-&gt;</span><span class="token function">hashPassword</span><span class="token punctuation">(</span><span class="token variable">$entity</span><span class="token punctuation">,</span> <span class="token variable">$entity</span><span class="token operator">-&gt;</span><span class="token function">getPlainPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><h2 id="creer-nos-propres-evenements"><a href="#creer-nos-propres-evenements" class="header-anchor">#</a> Créer nos propres événements</h2> <p>La <a href="https://symfony.com/doc/current/components/event_dispatcher.html" target="_blank" rel="noopener noreferrer">documentation du composant EventDispatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Exemple de création d'événements personnalisés, en vidéo :</p> <div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.loom.com/embed/71b2c1735f80442d95f0c16cdb12dad3" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="allowfullscreen" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div> <p>Les événements sont représentés par un nom <strong>unique</strong> et sont lié à un objet d'événement, qui sera transmis aux listeners, afin de fournir des informations supplémentaires.</p> <p>Le nom de l'événement doit suivre les conventions suivantes :</p> <ul><li>il est en minuscule, ne peut contenir que des nombres, des points (<code>.</code>) ou des underscores (<code>_</code>)</li> <li>il est toujours composé d'au moins 2 mots, dont le premier représente un espace de nom et se sépare du mot suivant pas un point <code>.</code> (exemple <code>order.</code>)</li> <li>le nom final est un verbe, indiquant l'action qui a été produite (exemple <code>order.placed</code>)</li></ul> <p>Pour des questions de rangement et de clarté, je vous recommande de définir ce nom dans une constante de classe, rangée dans un dossier <code>Event</code>.
Un exemple pour un site de vente, pourrait être un fichier <code>src/Event/OrderEvents.php</code> (noter le pluriel) (⚠️ ce fichier n'est pas obligatoire, vous pouvez également indiquer le nom de votre event directement dans l'objet Event) :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Event</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>OrderStartedEvent</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>OrderPlacedEvent</span><span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">OrderEvents</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * Pour simplifier la completion par les IDE 
     * et se rappeler plus aisément l'événement associé, 
     * on ajoute une annotation pour l'indiquer
     * 
     * @Event(&quot;App\Event\OrderStartedEvent&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">STARTED</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'order.started'</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * @Event(&quot;App\Event\OrderPlacedEvent&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">PLACED</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'order.placed'</span><span class="token punctuation">;</span>

    <span class="token comment">// On ajoute des aliases, qui peuvent être utilisés </span>
    <span class="token comment">// dans certains cas précis, pour lier events et noms</span>
    <span class="token comment">// (si vos events font partie d'un bundle, par exemple)</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">ALIASES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token class-name static-context">OrderStartedEvent</span><span class="token operator">::</span><span class="token keyword">class</span> <span class="token operator">=&gt;</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STARTED</span><span class="token punctuation">,</span>
        <span class="token class-name static-context">OrderPlacedEvent</span><span class="token operator">::</span><span class="token keyword">class</span>  <span class="token operator">=&gt;</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PLACED</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Le fichier <code>src/Event/OrderPlacedEvent.php</code> (noter le singulier) ressemblerait à ceci :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>Event</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Entity<span class="token punctuation">\</span>Order</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>EventDispatcher<span class="token punctuation">\</span>Event</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">OrderPlacedEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span>
<span class="token punctuation">{</span>
    <span class="token comment">// On peut également indiquer le nom de l'événement directement dans celui-ci</span>
    <span class="token comment">// Pour éviter de créer 2 classes</span>
    <span class="token comment">// public const NAME = 'order.placed';</span>

    <span class="token keyword">private</span> <span class="token class-name type-declaration">Order</span> <span class="token variable">$order</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Order</span> <span class="token variable">$order</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">order</span> <span class="token operator">=</span> <span class="token variable">$order</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Order</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">order</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Un Event Listener ou un Event Subscriber pourrait alors s'enregistrer pour l'un des événements présents dans <code>OrderEvents</code> et utiliser l'objet <code>Order</code> contenu dans l'événement pour ajouter un traitement (génération d'un numéro de facture, envoi d'un fichier <code>pdf</code>, etc.).</p> <h2 id="declencher-un-evenement-manuellement"><a href="#declencher-un-evenement-manuellement" class="header-anchor">#</a> Déclencher un événement manuellement</h2> <p>Dans notre exemple précédent, nous avons créé un événement, mais n'avions pas de moyen de le déclencher. Pour cela, nous allons utiliser le service <code>EventDispatcher</code> de Symfony pour le faire.</p> <p>Depuis un controller, dans une action :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// On récupère le service event dispatcher</span>
<span class="token variable">$eventDispatcher</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'event_dispatcher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// On crée un event, contenant les informations qui seront utiles au listener</span>
<span class="token variable">$event</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderPlacedEvent</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// On envoi l'événement, qui sera rattrapé par des listeners</span>
<span class="token variable">$eventDispatcher</span><span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">,</span> <span class="token class-name static-context">OrderEvents</span><span class="token operator">::</span><span class="token constant">STARTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Dans un service :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// On injecte l'event dispatcher dans notre service</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EventDispatcherInterface</span> <span class="token variable">$dispatcher</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dispatcher</span> <span class="token operator">=</span> <span class="token variable">$dispatcher</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">doSomethingWithAnOrder</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Order</span> <span class="token variable">$order</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// On crée un event, contenant les informations qui seront utiles au listener</span>
    <span class="token variable">$event</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderPlacedEvent</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// On envoi l'événement, qui sera rattrapé par des listeners</span>
    <span class="token variable">$eventDispatcher</span><span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">,</span> <span class="token class-name static-context">OrderEvents</span><span class="token operator">::</span><span class="token constant">STARTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/symfony/26-translation.html" class="prev">
        Les traductions
      </a></span> <span class="next"><a href="/symfony/30-user.html">
        Connexion et sécurisation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a0283a3d.js" defer></script><script src="/assets/js/2.2bb1f65b.js" defer></script><script src="/assets/js/51.43768ca2.js" defer></script>
  </body>
</html>
